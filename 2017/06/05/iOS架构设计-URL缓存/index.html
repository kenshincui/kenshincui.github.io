<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>iOSæ¶æ„è®¾è®¡-URLç¼“å­˜ | Kenshin Cui&#39;s Blog</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="iOS Developer">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="iOSæ¶æ„è®¾è®¡-URLç¼“å­˜ | Kenshin Cui&#39;s Blog">
    <meta name="twitter:description" content="iOS Developer">

    <meta property="og:type" content="article">
    <meta property="og:title" content="iOSæ¶æ„è®¾è®¡-URLç¼“å­˜ | Kenshin Cui&#39;s Blog">
    <meta property="og:description" content="iOS Developer">

    
    <meta name="author" content="Kenshin Cui">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/favicon.ico">
    

    <meta name="generator" content="hexo"/>
    

    <link rel="canonical" href="http://yoursite.com/2017/06/05/iOSæ¶æ„è®¾è®¡-URLç¼“å­˜/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="å‰å¾€ Kenshin Cui&#39;s Blog çš„ä¸»é¡µ"><img src="/images/avatar.jpg" width="80" alt="Kenshin Cui&#39;s Blog logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Kenshin Cui&#39;s Blog">Kenshin Cui&#39;s Blog</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">å³ä¾¿æ˜¯åˆ«äººçœ‹ä¸åˆ°çš„åœ°æ–¹, å¯¹å…¶å·¥è‰ºä¹Ÿå¿…é¡»å°½å¿ƒå°½åŠ›ã€‚</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">iOS Developer</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="è®¿é—®åšå®¢" class="blog-button">åšå®¢</a></li>
            
              <li class="navigation__item"><a href="/archive">å½’æ¡£</a></li>
            
              <li class="navigation__item"><a href="/about">å…³äº</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/kenshincui" title="æŸ¥çœ‹æˆ‘çš„GitHubä¸»é¡µ" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-green"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2017-06-05T07:53:20.000Z" class="post-list__meta--date date">2017-06-05</time> &#8226; <span class="post-meta__tags tags">äº&nbsp;
  <a class="tag-link" href="/tags/NSURLCache-AlamofireURLCache-NSURLProtocol/">NSURLCache,AlamofireURLCache,NSURLProtocol</a>
 </span>
      <span class="page-pv">
      &nbsp;é˜…è¯»&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">iOSæ¶æ„è®¾è®¡-URLç¼“å­˜</h1>
  </header>

  <section class="post">
    <h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>ç¼“å­˜ç»„ä»¶åº”è¯¥è¯´æ˜¯æ¯ä¸ªå®¢æˆ·ç«¯ç¨‹åºå¿…å¤‡çš„æ ¸å¿ƒç»„ä»¶ï¼Œè¯•æƒ³å¯¹äºæ¯ä¸ªç•Œé¢çš„è®¿é—®éƒ½å¿…é¡»é‡æ–°è¯·æ±‚åŠ¿å¿…é™ä½ç”¨æˆ·ä½“éªŒã€‚ä½†æ˜¯å¦‚ä½•å¤„ç†å®¢æˆ·ç«¯ç¼“å­˜è²Œä¼¼å¹¶æ²¡æœ‰ç»Ÿä¸€çš„è§£å†³æ–¹æ¡ˆï¼Œå¤šæ•°å¼€å‘è€…é€‰æ‹©è‡ªè¡Œåˆ›å»ºæ•°æ®åº“ç›´æ¥å°†æœåŠ¡å™¨ç«¯è¯·æ±‚çš„JSONï¼ˆæˆ–Modelï¼‰ç¼“å­˜èµ·æ¥ï¼Œä¸‹æ¬¡è¯·æ±‚åˆ™æŸ¥è¯¢æ•°æ®åº“æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨ï¼›å¦å¤–è¿˜æœ‰äº›å¼€å‘è€…ä¼šé€‰æ‹©ä»¥å½’æ¡£æ–‡ä»¶çš„æ–¹å¼ä¿å­˜ç¼“å­˜æ•°æ®ï¼Œæ¯æ¬¡è¯·æ±‚èµ„æºä¹‹å‰æ£€æŸ¥ç›¸åº”çš„ç¼“å­˜æ–‡ä»¶ã€‚äº‹å®ä¸ŠiOSç³»ç»Ÿè‡ªèº«å°±æä¾›äº†ä¸€å¥—ç¼“å­˜æœºåˆ¶ï¼Œæœ¬æ–‡å°†ç»“åˆURL Loading Systemä»‹ç»ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨ç³»ç»Ÿè‡ªèº«ç¼“å­˜è®¾è®¡æ¥å®ç°ä¸€å¥—ç¼“å­˜æœºåˆ¶ï¼Œä½¿ç”¨è¿™å¥—ç¼“å­˜è®¾è®¡ä½ æ— éœ€è‡ªå·±ç¼–å†™å†…å­˜å’Œç£ç›˜å­˜å‚¨ï¼Œæ— éœ€è‡ªè¡Œæ£€æŸ¥ç¼“å­˜è¿‡æœŸç­–ç•¥å°±èƒ½è½»æ¾å®ç°æ•°æ®ç¼“å­˜ã€‚</p>
<h1 id="URL-Loading-System"><a href="#URL-Loading-System" class="headerlink" title="URL Loading System"></a>URL Loading System</h1><p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/URLLoadingSystem/URLLoadingSystem.html" target="_blank" rel="external">URL Loading System</a>æ˜¯ç±»å’Œåè®®çš„é›†åˆï¼Œä½¿ç”¨URL Loading System iOSç³»ç»Ÿå’ŒæœåŠ¡å™¨ç«¯è¿›è¡Œç½‘ç»œäº¤äº’ã€‚<strong>URL</strong>ä½œä¸ºå…¶ä¸­çš„æ ¸å¿ƒï¼Œèƒ½å¤Ÿè®©appå’Œèµ„æºè¿›è¡Œè½»æ¾çš„äº¤äº’ã€‚ä¸ºäº†å¢å¼ºURLçš„åŠŸèƒ½Foundationæä¾›äº†ä¸°å¯Œçš„ç±»é›†åˆï¼Œèƒ½å¤Ÿè®©ä½ æ ¹æ®åœ°å€åŠ è½½èµ„æºã€ä¸Šä¼ èµ„æºåˆ°æœåŠ¡å™¨ã€ç®¡ç†cookieã€æ§åˆ¶å“åº”ç¼“å­˜ï¼ˆ<em>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹å†…å®¹</em>ï¼‰ã€å¤„ç†è¯ä¹¦å’Œè®¤è¯ã€æ‰©å±•ç”¨æˆ·åè®®ï¼ˆ<em>åé¢ä¹Ÿä¼šæåˆ°ç›¸å…³å†…å®¹</em>ï¼‰ç­‰ï¼Œå› æ­¤URLç¼“å­˜ä¹‹å‰ç†Ÿæ‚‰URL Loading Systemæ˜¯å¿…è¦çš„ã€‚ä¸‹å›¾ä¸€ç³»åˆ—é›†åˆçš„å…³ç³»ï¼š</p>
<p><img src="/media/nsobject_hierarchy_2x.png" alt="URL_Loading_System" style="max-width:750px"></p>
<blockquote>
<p>æœ¬æ–‡ä»£ç ä¸€å¾‹ä½¿ç”¨Swiftç¼–å†™ï¼Œä½†æ˜¯é‰´äºå¾ˆå¤šæœ‹å‹æ¥è§¦URL Loading Systeméƒ½æ˜¯ä»Objective-Cå¼€å§‹ï¼Œæ‰€ä»¥æ–‡ç« ä¸­æ–‡å­—éƒ¨åˆ†è¿˜æ˜¯é‡‡ç”¨OCå‘½åï¼Œå…¶åŒºåˆ«ä¸å¤§ï¼Œä¸»è¦æ˜¯å°‘äº†<em>NS</em>å‰ç¼€ã€‚</p>
</blockquote>
<p>##NSURLProtocol</p>
<p>URL Loading Systemé»˜è®¤æ”¯æŒhttpã€httpsã€ftpã€fileå’Œdata åè®®ï¼Œä½†æ˜¯å®ƒåŒæ ·ä¹Ÿæ”¯æŒä½ æ³¨å†Œè‡ªå·±çš„ç±»æ¥æ”¯æŒæ›´å¤šåº”ç”¨å±‚ç½‘ç»œåè®®ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æŒ‡å®šå…¶ä»–å±æ€§åˆ°URL reqeustå’ŒURL responseä¸Šã€‚å…·ä½“è€Œè¨€NSURLProtoclå¯ä»¥å®ç°ä»¥ä¸‹éœ€æ±‚ï¼ˆåŒ…å«ä½†ä¸é™ï¼‰ï¼š</p>
<ul>
<li>é‡å®šå‘ç½‘ç»œè¯·æ±‚ï¼ˆæˆ–è¿›è¡ŒåŸŸåè½¬åŒ–ã€æ‹¦æˆªç­‰ï¼Œä¾‹å¦‚ï¼š<a href="https://github.com/kasketis/netfox" target="_blank" rel="external">netfox</a>ï¼‰</li>
<li>å¿½ç•¥æŸäº›è¯·æ±‚ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®</li>
<li>è‡ªå®šä¹‰ç½‘ç»œè¯·æ±‚çš„è¿”å›ç»“æœ ï¼ˆæ¯”å¦‚ï¼š<a href="https://github.com/hypoyao/GYHttpMock" target="_blank" rel="external">GYHttpMocking</a>ï¼‰</li>
<li>è¿›è¡Œç½‘ç»œå…¨å±€é…ç½®</li>
</ul>
<p>NSURLProtocolç±»ä¼¼ä¸­é—´äººè®¾è®¡ï¼Œå°†ç½‘ç»œæ±‚ç»†èŠ‚æä¾›ç»™å¼€å‘è€…ï¼Œè€Œåˆä»¥ä¸€ç§ä¼˜é›…çš„æ–¹å¼æš´æ¼å‡ºæ¥ã€‚NSURLProtocolçš„å®šä¹‰æ›´åƒæ˜¯ä¸€ä¸ªURLåè®®ï¼Œå°½ç®¡å®ƒç»§æ‰¿è‡ªNSObjectå´ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä½¿ç”¨æ—¶è‡ªå®šä¹‰åè®®ç»§æ‰¿NSURLProtocolï¼Œç„¶ååœ¨appå¯åŠ¨æ—¶æ³¨å†Œå³å¯ï¼Œè¿™æ ·ä¸€æ¥æ‰€æœ‰è¯·æ±‚ç»†èŠ‚å¼€å‘è€…åªéœ€è¦åœ¨è‡ªå·±çš„ç±»ä¸­æ§åˆ¶å³å¯ï¼ˆè¿™ä¸ªè®¾è®¡ç¡®å®å®Œç¾ğŸ‘ï¼‰ã€‚</p>
<h3 id="è§£å†³DNSåŠ«æŒ"><a href="#è§£å†³DNSåŠ«æŒ" class="headerlink" title="è§£å†³DNSåŠ«æŒ"></a>è§£å†³DNSåŠ«æŒ</h3><p>éšç€äº’è”ç½‘çš„å‘å±•ï¼Œè¿è¥å•†åŠ«æŒè¿™äº›å¹´é€æ¸è¢«å¤§å®¶æ‰€æåŠï¼Œå¸¸è§çš„åŠ«æŒåŒ…æ‹¬HTTPåŠ«æŒå’ŒDNSåŠ«æŒã€‚å¯¹äºHTTPåŠ«æŒæ›´å¤šçš„æ˜¯ç¯¡æ”¹ç½‘ç»œå“åº”åŠ å…¥ä¸€äº›è„šæœ¬å¹¿å‘Šä¹‹ç±»çš„å†…å®¹ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦ä½¿ç”¨httpsåŠ å¯†è¯·æ±‚äº¤äº’å†…å®¹ï¼›è€Œå¯¹äºDNSåŠ«æŒåˆ™æ›´åŠ å¯æ¶ï¼Œåœ¨DNSè§£ææ—¶è®©è¯·æ±‚é‡æ–°å®šå‘åˆ°ä¸€ä¸ªéé¢„æœŸIPä»è€Œè¾¾åˆ°å†…å®¹ç¯¡æ”¹ã€‚</p>
<p>è§£å†³DNSåŠ«æŒæ™®éçš„åšæ³•å°±æ˜¯å°†URLä»åŸŸåæ›¿æ¢æˆIPï¼Œè¿™ä¹ˆä¸€æ¥è®¿é—®å†…å®¹å¹¶ä¸ç»è¿‡è¿è¥å•†çš„Local DNSè€Œåˆ°è¾¾æŒ‡å®šçš„æœåŠ¡å™¨ï¼Œå› æ­¤ä¹Ÿå°±é¿å…äº†DNSåŠ«æŒé—®é¢˜ã€‚å½“ç„¶ï¼ŒåŸŸåå’ŒIPçš„å¯¹åº”è¦é€šå¸¸é€šè¿‡æœåŠ¡å™¨ä¸‹å‘ä¿è¯è·å–æœ€è¿‘çš„èµ„æºèŠ‚ç‚¹ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥é‡‡ç”¨ä¸€äº›æ”¶è´¹çš„HTTPDNSæœåŠ¡ï¼‰ï¼Œä¸è¿‡è¿™æ ·ä¸€æ¥æ“ä½œå´ä¸å¾—ä¸ä¾èµ–äºå…·ä½“è¯·æ±‚ï¼Œè€Œä½¿ç”¨è‡ªå®šä¹‰NSURLProtocolçš„æ–¹å¼åˆ™å¯ä»¥å½»åº•è§£å†³å…·ä½“ä¾èµ–é—®é¢˜ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨NSURLConnectionã€NSURLSessionã€AFNetworkingè¿˜æ˜¯UIWebView(æ³¨æ„WKWebViewæœ‰æ‰€ä¸åŒ)ï¼Œæ‰€æœ‰çš„æ›¿æ¢æ“ä½œéƒ½å¯ä»¥ç»Ÿä¸€è¿›è¡Œæ§åˆ¶ã€‚</p>
<p>ä¸‹é¢çš„demoä¸­è‡ªå®šä¹‰åè®®<strong>MyURLProtocol</strong>å®ç°äº†å°†åŸŸåè½¬åŒ–æˆIPè¿›è¡Œè¯·æ±‚çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyURLProtocol</span>: <span class="title">URLProtocol</span></span>&#123;</span><br><span class="line">    <span class="comment">// MARK: - URLProtocolè™šæ–¹æ³•å®ç°</span></span><br><span class="line">    <span class="comment">// æ˜¯å¦å¤„ç†å¯¹åº”çš„è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">canInit</span>(<span class="title">with</span> <span class="title">request</span>: <span class="title">URLRequest</span>) -&gt; <span class="title">Bool</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="type">URLProtocol</span>.property(forKey: <span class="type">MyURLProtocol</span>.<span class="type">PropertyKey</span>.tagKey, <span class="keyword">in</span>: request) != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›è¯·æ±‚ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­å¯ä»¥ä¿®æ”¹è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">canonicalRequest</span>(<span class="title">for</span> <span class="title">request</span>: <span class="title">URLRequest</span>) -&gt; <span class="title">URLRequest</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> newRequest = request</span><br><span class="line">        <span class="comment">// ä¾‹å¦‚è¿™é‡ŒåŸŸåä¸ºæŒ‡å®šipï¼Œå®é™…å¼€å‘ä¸­åº”è¯¥ä»æœåŠ¡å™¨ä¸‹æ–¹domain list</span></span><br><span class="line">        <span class="keyword">let</span> originHost = request.url?.host</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"baidu.com"</span> == originHost &#123;</span><br><span class="line">            <span class="keyword">let</span> originURL = request.url?.absoluteString</span><br><span class="line">            <span class="keyword">let</span> newURL = originURL?.replacingOccurrences(of: originHost!, with: <span class="string">"61.135.169.121"</span>)</span><br><span class="line">            newRequest.url = <span class="type">URL</span>(string: newURL!)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newRequest</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¼€å§‹åŠ è½½</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">startLoading</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> newRequest = (request <span class="keyword">as</span> <span class="type">NSURLRequest</span>).mutableCopy() <span class="keyword">as</span>? <span class="type">NSMutableURLRequest</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span>&#125;</span><br><span class="line">        <span class="type">URLProtocol</span>.setProperty(<span class="literal">true</span>, forKey: <span class="type">MyURLProtocol</span>.<span class="type">PropertyKey</span>.tagKey, <span class="keyword">in</span>: newRequest)</span><br><span class="line">        <span class="keyword">let</span> sessionConfig = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">        <span class="keyword">let</span> urlSession = <span class="type">URLSession</span>(configuration: sessionConfig, delegate: <span class="keyword">self</span>, delegateQueue: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">self</span>.dataTask = urlSession.dataTask(with: <span class="keyword">self</span>.request)</span><br><span class="line">        <span class="keyword">self</span>.dataTask?.resume()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœæ­¢åŠ è½½</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">stopLoading</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.dataTask?.cancel()</span><br><span class="line">        <span class="keyword">self</span>.dataTask       = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.receivedData   = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.urlResponse    = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¸¤ä¸ªè¯·æ±‚æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™è€ƒè™‘ä½¿ç”¨ç¼“å­˜ï¼Œæ­¤æ–¹æ³•ä¸æ˜¯å¿…é¡»å®ç°</span></span><br><span class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">requestIsCacheEquivalent</span>(_ <span class="title">a</span>: <span class="title">URLRequest</span>, <span class="title">to</span> <span class="title">b</span>: <span class="title">URLRequest</span>) -&gt; <span class="title">Bool</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.requestIsCacheEquivalent(a, to: b)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - ç§æœ‰å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">struct</span> <span class="title">MyURLProtocolKey</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> tagKey = <span class="string">"MyURLProtocolTagKey"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fileprivate <span class="keyword">var</span> dataTask: <span class="type">URLSessionDataTask</span>?</span><br><span class="line">    fileprivate <span class="keyword">var</span> urlResponse: <span class="type">URLResponse</span>?</span><br><span class="line">    fileprivate <span class="keyword">var</span> receivedData: <span class="type">NSMutableData</span>?</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MyURLProtocol</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PropertyKey</span></span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> tagKey = <span class="string">"MyURLProtocolTagKey"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„å®é™…å¼€å‘ä¸­åº”è¯¥å°½å¯èƒ½å¤„ç†æ‰€æœ‰self.client?.urlProtocolå›ä¼ æ–¹æ³•ï¼Œä»¥å…å®¢æˆ·ç«¯æœ‰äº›æ–¹æ³•æ— æ³•åšå‡ºå“åº”</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MyURLProtocol</span>:<span class="title">URLSessionTaskDelegate</span>,<span class="title">URLSessionDataDelegate</span> </span>&#123;</span><br><span class="line">    <span class="comment">// MARK: - URLSessionDataDelegateæ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping <span class="params">(URLSession.ResponseDisposition)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.client?.urlProtocol(<span class="keyword">self</span>, didReceive: response, cacheStoragePolicy: .notAllowed)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.urlResponse = response</span><br><span class="line">        <span class="keyword">self</span>.receivedData = <span class="type">NSMutableData</span>()</span><br><span class="line">        </span><br><span class="line">        completionHandler(.allow)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive data: Data)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.client?.urlProtocol(<span class="keyword">self</span>, didLoad: data <span class="keyword">as</span> <span class="type">Data</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.receivedData?.append(data <span class="keyword">as</span> <span class="type">Data</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// URLSessionTaskDelegate</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.client?.urlProtocol(<span class="keyword">self</span>, didFailWithError: error!)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//saveCachedResponse()</span></span><br><span class="line">            <span class="keyword">self</span>.client?.urlProtocolDidFinishLoading(<span class="keyword">self</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ä½¿ç”¨URLSessionè¿›è¡Œç½‘ç»œè¯·æ±‚æ—¶å¦‚æœä½¿ç”¨çš„ä¸æ˜¯é»˜è®¤ä¼šè¯ï¼ˆURLSession.sharedï¼‰åˆ™éœ€è¦åœ¨URLSessionConfigurationä¸­æŒ‡å®š<strong>protocolClasses</strong>è‡ªå®šä¹‰URLProtocolæ‰èƒ½è¿›è¡Œå¤„ç†ï¼ˆå³ä½¿ä½¿ç”¨URLProtocol.registerClassè¿›è¡Œæ³¨å†Œï¼‰ï¼ŒURLSession.sharedé»˜è®¤åˆ™å¯ä»¥å“åº”å·²æ³¨å†ŒURLProtocolã€‚<br>åœ¨MyURLProtocolçš„<strong>startLoading</strong>æ–¹æ³•å†…åŒæ ·å‘èµ·äº†URLè¯·æ±‚ï¼Œå¦‚æœæ­¤æ—¶ä½¿ç”¨äº†URLSession.sharedè¿›è¡Œç½‘ç»œè¯·æ±‚åˆ™åŒæ ·ä¼šé€ æˆMyURLProtocolè°ƒç”¨ï¼Œå¦‚æ­¤ä¼šå¼•èµ·å¾ªç¯è°ƒç”¨ã€‚è€ƒè™‘åˆ°<strong>startLoading</strong>æ–¹æ³•èƒ½å¯èƒ½æ˜¯NSURLConnnectionå®ç°ï¼Œå®‰å…¨èµ·è§åœ¨MyURLProtocolå†…éƒ¨ä½¿ç”¨<strong>URLProtocol.setProperty(true, forKey: MyCacheURLProtocolTagKey, in: newRequest)</strong>æ¥æ ‡è®°ä¸€ä¸ªè¯·æ±‚ï¼Œè°ƒç”¨å‰ä½¿ç”¨<strong>URLProtocol.property(forKey: MyCacheURLProtocolTagKey, in: request)</strong>åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦å·²ç»æ ‡è®°ï¼Œå¦‚æœå·²ç»æ ‡è®°åˆ™è§†ä¸ºåŒä¸€è¯·æ±‚ï¼ŒMyURLProtocolåˆ™ä¸å†å¤„ç†ï¼Œä»è€Œé¿å…åŒä¸€ä¸ªè¯·æ±‚å¾ªç¯è°ƒç”¨ã€‚</p>
<blockquote>
<p>å¦‚æœä½ çš„ç½‘ç»œè¯·æ±‚ä½¿ç”¨çš„NSURLConnectionï¼Œä¸Šé¢çš„ä»£ç éœ€è¦åšç›¸åº”ä¿®æ”¹ï¼Œä½†ç›¸ä¿¡ç°åœ¨NSURLConnectionä½¿ç”¨åº”è¯¥è¶Šæ¥è¶Šå°‘äº†ï¼Œå¾ˆå¤šç¬¬ä¸‰æ–¹ç½‘ç»œåº“ä¹Ÿä¸æ”¯æŒäº†ã€‚</p>
</blockquote>
<h3 id="NSURLProtocolç¼“å­˜"><a href="#NSURLProtocolç¼“å­˜" class="headerlink" title="NSURLProtocolç¼“å­˜"></a>NSURLProtocolç¼“å­˜</h3><p>å…¶å®æ— è®ºæ˜¯NSURLConnectionã€NSURLSessionè¿˜æ˜¯UIWebViewã€WKWebViewé»˜è®¤éƒ½æ˜¯æœ‰ç¼“å­˜è®¾è®¡çš„ï¼ˆä½¿ç”¨NSURLCacheï¼Œåé¢ä¼šç€é‡ä»‹ç»ï¼‰ï¼Œä¸è¿‡è¿™è¦é…åˆæœåŠ¡å™¨ç«¯response headerä½¿ç”¨ï¼Œå¯¹äºæœ‰ç¼“å­˜çš„é¡µé¢ï¼ˆæˆ–è€…APIæ¥å£ï¼‰ï¼Œå½“ç¼“å­˜è¿‡æœŸåï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ˆNSURLRequestUseProtocolCachePolicyï¼‰é‡åˆ°åŒä¸€ä¸ªè¯·æ±‚åˆ™é€šå¸¸ä¼šå‘å‡ºä¸€ä¸ªheaderä¸­åŒ…å«<strong>If-Modified-Since</strong>çš„è¯·æ±‚åˆ°æœåŠ¡å™¨ç«¯éªŒè¯ï¼Œå¦‚æœå†…å®¹æ²¡æœ‰è¿‡æœŸåˆ™è¿”å›ä¸€ä¸ªä¸å«æœ‰bodyçš„å“åº”ï¼ˆResponse codeä¸º304ï¼‰ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå¦åˆ™é‡æ–°è¿”å›æ–°çš„æ•°æ®ã€‚</p>
<p>ç”±äºWKWebViewé»˜è®¤æœ‰å‡ åç§’çš„ç¼“å­˜æ—¶é—´ï¼Œåœ¨ç¬¬ä¸€æ¬¡ç¼“å­˜å“åº”åè¿‡ä¸€æ®µæ—¶é—´æ‰ä¼šè¿›è¡Œç¼“å­˜è¯·æ±‚æ£€æŸ¥ï¼ˆç¼“å­˜è¿‡æœŸåæ‰ä¼šå‘é€åŒ…å«<strong>If-Modified-Since</strong>çš„è¯·æ±‚æ£€æŸ¥ï¼‰ã€‚ä½†æ˜¯è¿™å¹¶ä¸æ˜¯è¯´è‡ªå·±è®¾è®¡ç¼“å­˜å°±å®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œç¬¬ä¸€å®ƒåšä¸åˆ°å®Œå…¨çš„ç¦»çº¿åé˜…è¯»ï¼ˆå°½ç®¡åœ¨ä¸€å®šæ—¶é—´å†…ä¸éœ€è¦æ£€æŸ¥ï¼Œä½†æ˜¯è¿‡ä¸€æ®µæ—¶é—´è¿˜æ˜¯éœ€è¦è”ç½‘æ£€æŸ¥çš„ï¼‰ï¼Œç¬¬äºŒæ— æ³•åšåˆ°ç¼“å­˜ç»†èŠ‚çš„æ§åˆ¶ã€‚</p>
<p>ä¸‹é¢ç®€å•åˆ©ç”¨NSURLProtocolæ¥å®ç°WKWebViewçš„ç¦»çº¿ç¼“å­˜åŠŸèƒ½ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯WKWebViewé»˜è®¤ä»…ä»…è°ƒç”¨NSURLProtocolçš„<strong>canInitWithRequest:</strong>æ–¹æ³•ï¼Œå¦‚æœè¦çœŸæ­£åˆ©ç”¨NSURLProtocolè¿›è¡Œç¼“å­˜è¿˜å¿…é¡»ä½¿ç”¨WKBrowsingContextControllerçš„registerSchemeForCustomProtocolè¿›è¡Œæ³¨å†Œï¼Œä¸è¿‡è¿™æ˜¯ä¸ªç§æœ‰å¯¹è±¡ï¼Œéœ€è¦ä½¿ç”¨é»‘é­”æ³•ã€‚ä¸‹é¢çš„demoä¸­ç®€å•å®ç°äº†WKWebViewçš„ç¦»çº¿ç¼“å­˜åŠŸèƒ½ï¼Œæœ‰äº†å®ƒä¹‹åé‡åˆ°è®¿é—®è¿‡çš„èµ„æºå³ä½¿æ²¡æœ‰ç½‘ç»œä¹ŸåŒæ ·å¯ä»¥è®¿é—®ã€‚å½“ç„¶ï¼Œç¤ºä¾‹ä¸»è¦ç”¨ä»¥è¯´æ˜ç¼“å­˜çš„åŸç†ï¼Œå®é™…å¼€å‘ä¸­è¿˜æœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒï¼Œæ¯”å¦‚è¯´ç¼“å­˜è¿‡æœŸæœºåˆ¶ã€ç£ç›˜ç¼“å­˜ä¿å­˜æ–¹å¼ç­‰ç­‰ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCacheURLProtocol</span>: <span class="title">URLProtocol</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - URLProtocolè™šæ–¹æ³•å®ç°</span></span><br><span class="line">    <span class="comment">// æ˜¯å¦å¤„ç†å¯¹åº”çš„è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">canInit</span>(<span class="title">with</span> <span class="title">request</span>: <span class="title">URLRequest</span>) -&gt; <span class="title">Bool</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="type">URLProtocol</span>.property(forKey: <span class="type">MyCacheURLProtocol</span>.<span class="type">PropertyKey</span>.tagKey, <span class="keyword">in</span>: request) != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›è¯·æ±‚ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­å¯ä»¥ä¿®æ”¹è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">canonicalRequest</span>(<span class="title">for</span> <span class="title">request</span>: <span class="title">URLRequest</span>) -&gt; <span class="title">URLRequest</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¼€å§‹åŠ è½½</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">startLoading</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">sendRequest</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> newRequest = (request <span class="keyword">as</span> <span class="type">NSURLRequest</span>).mutableCopy() <span class="keyword">as</span>? <span class="type">NSMutableURLRequest</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span>&#125;</span><br><span class="line">            <span class="type">URLProtocol</span>.setProperty(<span class="literal">true</span>, forKey: <span class="type">MyCacheURLProtocol</span>.<span class="type">PropertyKey</span>.tagKey, <span class="keyword">in</span>: newRequest)</span><br><span class="line">            <span class="keyword">let</span> sessionConfig = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">            <span class="keyword">let</span> urlSession = <span class="type">URLSession</span>(configuration: sessionConfig, delegate: <span class="keyword">self</span>, delegateQueue: <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">self</span>.dataTask = urlSession.dataTask(with: <span class="keyword">self</span>.request)</span><br><span class="line">            <span class="keyword">self</span>.dataTask?.resume()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> cacheResponse = <span class="keyword">self</span>.getResponse() &#123;</span><br><span class="line">            <span class="keyword">self</span>.client?.urlProtocol(<span class="keyword">self</span>, didReceive: cacheResponse.response, cacheStoragePolicy: .notAllowed)</span><br><span class="line">            <span class="keyword">self</span>.client?.urlProtocol(<span class="keyword">self</span>, didLoad: cacheResponse.data)</span><br><span class="line">            <span class="keyword">self</span>.client?.urlProtocolDidFinishLoading(<span class="keyword">self</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sendRequest()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœæ­¢åŠ è½½</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">stopLoading</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.dataTask?.cancel()</span><br><span class="line">        <span class="keyword">self</span>.dataTask       = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.receivedData   = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.urlResponse    = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¸¤ä¸ªè¯·æ±‚æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™è€ƒè™‘ä½¿ç”¨ç¼“å­˜ï¼Œæ­¤æ–¹æ³•ä¸æ˜¯å¿…é¡»å®ç°</span></span><br><span class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">requestIsCacheEquivalent</span>(_ <span class="title">a</span>: <span class="title">URLRequest</span>, <span class="title">to</span> <span class="title">b</span>: <span class="title">URLRequest</span>) -&gt; <span class="title">Bool</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.requestIsCacheEquivalent(a, to: b)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - ç§æœ‰æ–¹æ³•</span></span><br><span class="line">    fileprivate <span class="function"><span class="keyword">func</span> <span class="title">saveResponse</span><span class="params">(<span class="number">_</span> response:URLResponse,<span class="number">_</span> data:Data)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> key = <span class="keyword">self</span>.request.url?.absoluteString &#123;</span><br><span class="line">            <span class="keyword">let</span> tempDic = <span class="type">NSTemporaryDirectory</span>() <span class="keyword">as</span> <span class="type">NSString</span></span><br><span class="line">            <span class="keyword">let</span> filePath = tempDic.appendingPathComponent(key.md5())</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> cacheResponse = <span class="type">CachedURLResponse</span>(response: response, data: data, userInfo: <span class="literal">nil</span>, storagePolicy: <span class="type">URLCache</span>.<span class="type">StoragePolicy</span>.notAllowed)</span><br><span class="line">            <span class="type">NSKeyedArchiver</span>.archiveRootObject(cacheResponse, toFile: filePath)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fileprivate <span class="function"><span class="keyword">func</span> <span class="title">getResponse</span><span class="params">()</span></span> -&gt; <span class="type">CachedURLResponse</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> key = <span class="keyword">self</span>.request.url?.absoluteString &#123;</span><br><span class="line">            <span class="keyword">let</span> tempDic = <span class="type">NSTemporaryDirectory</span>() <span class="keyword">as</span> <span class="type">NSString</span></span><br><span class="line">            <span class="keyword">let</span> filePath = tempDic.appendingPathComponent(key.md5())</span><br><span class="line">            <span class="keyword">if</span> <span class="type">FileManager</span>.<span class="keyword">default</span>.fileExists(atPath: filePath) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="type">NSKeyedUnarchiver</span>.unarchiveObject(withFile: filePath) <span class="keyword">as</span>? <span class="type">CachedURLResponse</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - ç§æœ‰å±æ€§</span></span><br><span class="line">    fileprivate <span class="keyword">var</span> dataTask: <span class="type">URLSessionDataTask</span>?</span><br><span class="line">    fileprivate <span class="keyword">var</span> urlResponse: <span class="type">URLResponse</span>?</span><br><span class="line">    fileprivate <span class="keyword">var</span> receivedData: <span class="type">NSMutableData</span>?</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MyCacheURLProtocol</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PropertyKey</span></span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> tagKey = <span class="string">"MyURLProtocolTagKey"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„å®é™…å¼€å‘ä¸­åº”è¯¥å°½å¯èƒ½å¤„ç†æ‰€æœ‰self.client?.urlProtocolå›ä¼ æ–¹æ³•ï¼Œä»¥å…å®¢æˆ·ç«¯æœ‰äº›æ–¹æ³•æ— æ³•åšå‡ºå“åº”</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MyCacheURLProtocol</span>:<span class="title">URLSessionTaskDelegate</span>,<span class="title">URLSessionDataDelegate</span> </span>&#123;</span><br><span class="line">    <span class="comment">// MARK: - URLSessionDataDelegateæ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping <span class="params">(URLSession.ResponseDisposition)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.client?.urlProtocol(<span class="keyword">self</span>, didReceive: response, cacheStoragePolicy: .notAllowed)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.urlResponse = response</span><br><span class="line">        <span class="keyword">self</span>.receivedData = <span class="type">NSMutableData</span>()</span><br><span class="line">        </span><br><span class="line">        completionHandler(.allow)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive data: Data)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.client?.urlProtocol(<span class="keyword">self</span>, didLoad: data <span class="keyword">as</span> <span class="type">Data</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.receivedData?.append(data <span class="keyword">as</span> <span class="type">Data</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// URLSessionTaskDelegate</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.client?.urlProtocol(<span class="keyword">self</span>, didFailWithError: error!)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.client?.urlProtocolDidFinishLoading(<span class="keyword">self</span>)</span><br><span class="line">            <span class="comment">//save cache</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.urlResponse != <span class="literal">nil</span> &amp;&amp; <span class="keyword">self</span>.receivedData != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.saveResponse(<span class="keyword">self</span>.urlResponse!, <span class="keyword">self</span>.receivedData?.copy() <span class="keyword">as</span>! <span class="type">Data</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NSURLCache"><a href="#NSURLCache" class="headerlink" title="NSURLCache"></a>NSURLCache</h2><p>äº‹å®ä¸Šæ— è®ºæ˜¯NSURLConnectionã€URLSessionè¿˜æ˜¯UIWebViewã€WKWebViewé»˜è®¤éƒ½æ˜¯åŒ…å«ç¼“å­˜çš„ï¼ˆæ³¨æ„WKWebViewçš„ç¼“å­˜é…ç½®æ˜¯ä»iOS 9.0å¼€å§‹æä¾›çš„ï¼Œä½†æ˜¯å…¶å®iOS 8.0ä¸­ä¹ŸåŒæ ·åŒ…å«ç¼“å­˜è®¾è®¡ï¼Œåªæ˜¯æ²¡æœ‰æä¾›ç¼“å­˜é…ç½®æ¥å£ï¼‰ã€‚å¯¹äºå¤šæ•°å¼€å‘è€…è€Œè¨€ç¼“å­˜è®¾è®¡è€ƒè™‘æ›´å¤šçš„æ˜¯ç£ç›˜ç¼“å­˜ï¼ˆå¦‚æœéœ€è¦åšå†…å­˜ç¼“å­˜å»ºè®®ä½¿ç”¨<a href="https://developer.apple.com/reference/foundation/nscache" target="_blank" rel="external">NSCache</a>ï¼Œæä¾›äº†ç¼“å­˜è¿‡é«˜è‡ªåŠ¨ç§»é™¤åŠŸèƒ½ or YYCacheï¼‰ï¼Œè€Œç£ç›˜ç¼“å­˜è®¾è®¡å¤§è‡´å¯ä»¥åˆ†ä¸ºAPIè®¿é—®è¿”å›çš„JSONç¼“å­˜ï¼ˆé€šè¿‡NSURLConnectionæˆ–è€…NSURLSessionè¯·æ±‚æ ‡å‡†çš„JSONæ•°æ®ï¼‰å’Œå®¢æˆ·ç«¯webé¡µé¢ç¼“å­˜ï¼ˆUIWebViewã€WKWebViewï¼‰ã€‚</p>
<p>NSURLConnectionå’ŒUIWebViewæ¥è¯´ï¼Œé»˜è®¤éƒ½ä¼šä½¿ç”¨NSURLCacheï¼Œé€šå¸¸åœ¨åº”ç”¨å¯åŠ¨ä¸­ä¼šè¿›è¡ŒNSURLCacheé…ç½®ï¼Œå½“ç„¶å³ä½¿ä¸è¿›è¡Œé…ç½®ä¹Ÿæ˜¯æœ‰é»˜è®¤é…ç½®çš„ã€‚ä½†äºŒè€…å¹¶ä¸æ˜¯ä»Šå¤©ä»‹ç»çš„é‡ç‚¹ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨NSURLSessionå’ŒWKWebViewã€‚å¯¹äºNSURLSessionè€Œè¨€é»˜è®¤ä»ç„¶ä¼šä½¿ç”¨å…¨å±€çš„NSURLCache(å¯ä»¥åœ¨å¯åŠ¨æ—¶è‡ªå·±åˆå§‹åŒ–ï¼Œä¾‹å¦‚<code>URLCache.shared = URLCache(memoryCapacity: 5*1024*1024, diskCapacity: 20*1024*1024, diskPath: nil)</code>)ï¼Œä½†æ˜¯ç›¸æ¯”äºé»˜è®¤NSURLConnectionè€Œè¨€NSURLSessionæ›´åŠ çµæ´»ï¼Œå› ä¸ºæ¯ä¸ªURLSessionConfigurationéƒ½å¯ä»¥æŒ‡å®šç‹¬ç«‹çš„URLCache,é»˜è®¤æƒ…å†µä¸‹æ˜¯ä½¿ç”¨ä¸€ä¸ªç§æœ‰å†…å­˜ç¼“å­˜ï¼Œå¦‚æœè®¾ç½®ä¸ºnilåˆ™ä¸å†ä½¿ç”¨ç¼“å­˜ã€‚è€Œä¸”è¿˜å¯ä»¥é€šè¿‡URLSessionConfigurationçš„requestCachePolicyå±æ€§æŒ‡å®šç¼“å­˜ç­–ç•¥ã€‚</p>
<h3 id="ç¼“å­˜ç­–ç•¥CachePolicy"><a href="#ç¼“å­˜ç­–ç•¥CachePolicy" class="headerlink" title="ç¼“å­˜ç­–ç•¥CachePolicy"></a>ç¼“å­˜ç­–ç•¥CachePolicy</h3><ul>
<li>useProtocolCachePolicyï¼šé»˜è®¤ç¼“å­˜ç­–ç•¥ï¼Œå¯¹äºç‰¹å®šURLä½¿ç”¨ç½‘ç»œåè®®ä¸­å®ç°çš„ç¼“å­˜ç­–ç•¥ã€‚</li>
<li>reloadIgnoringLocalCacheDataï¼ˆæˆ–è€…reloadIgnoringCacheDataï¼‰ï¼šä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥è¯·æ±‚åŸå§‹æ•°æ®ã€‚</li>
<li>returnCacheDataElseLoadï¼šæ— è®ºç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œæœ‰ç¼“å­˜åˆ™ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™é‡æ–°è¯·æ±‚åŸå§‹æ•°æ®ã€‚</li>
<li>returnCacheDataDontLoadï¼šæ— è®ºç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œæœ‰ç¼“å­˜åˆ™ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™è§†ä¸ºå¤±è´¥ï¼Œä¸ä¼šé‡æ–°è¯·æ±‚åŸå§‹æ•°æ®ã€‚</li>
</ul>
<p>å…¶å®å¯¹äºå¤šæ•°å¼€å‘è€…è€Œè¨€ï¼Œç¬¬äºŒç§æ ¹æœ¬ä¸ç¼“å­˜ï¼Œå…¶ä»–ä¸¤ç§ä¹Ÿå­˜åœ¨ç€å¾ˆå¤§çš„ä½¿ç”¨é£é™©ï¼Œæ‰€ä»¥é»˜è®¤ç¼“å­˜ç­–ç•¥æ‰æ˜¯æˆ‘ä»¬æœ€å…³å¿ƒçš„ï¼Œå®ƒä½¿ç”¨ç½‘ç»œåè®®ä¸­å®ç°çš„ç¼“å­˜ç­–ç•¥ï¼Œé‚£æˆ‘ä»¬å°±åº”è¯¥é¦–å…ˆå¼„æ¸…ç½‘ç»œåè®®ä¸­çš„ç¼“å­˜ç­–ç•¥æ˜¯å¦‚ä½•æ¥æ§åˆ¶çš„ï¼ˆæ³¨æ„ï¼šæ— è®ºæ˜¯NSURLConnectionè¿˜æ˜¯NSURLSessionéƒ½æ”¯æŒå¤šç§åè®®ï¼Œè¿™é‡Œé‡ç‚¹å…³æ³¨HTTPã€HTTPSï¼‰ã€‚</p>
<p>HTTPçš„è¯·æ±‚å’Œå“åº”ä½¿ç”¨headersæ¥è¿›è¡Œå…ƒæ•°æ®äº¤æ¢ï¼Œä¾‹å¦‚MIMEã€Encodingï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ç¼“å­˜æ‰§è¡Œï¼Œä¸‹é¢ä¼šç€é‡ä»‹ç»ç›¸å…³ç¼“å­˜é…ç½®ã€‚</p>
<h3 id="è¯·æ±‚å¤´ä¿¡æ¯-Request-cache-headers"><a href="#è¯·æ±‚å¤´ä¿¡æ¯-Request-cache-headers" class="headerlink" title="è¯·æ±‚å¤´ä¿¡æ¯ Request cache headers"></a>è¯·æ±‚å¤´ä¿¡æ¯ Request cache headers</h3><ul>
<li><strong>If-Modified-Since</strong>:ä¸å“åº”å¤´Last-Modifiedç›¸å¯¹åº”ï¼Œå…¶å€¼ä¸ºæœ€åä¸€æ¬¡å“åº”å¤´ä¸­çš„Last-Modifiedã€‚</li>
<li><strong>If-None-Match</strong>:ä¸å“åº”å¤´Etagç›¸å¯¹åº”ï¼Œå…¶å€¼ä¸ºæœ€åä¸€æ¬¡å“åº”å¤´ä¸­çš„Etagã€‚</li>
</ul>
<h3 id="å“åº”å¤´ä¿¡æ¯-Response-cache-headers"><a href="#å“åº”å¤´ä¿¡æ¯-Response-cache-headers" class="headerlink" title="å“åº”å¤´ä¿¡æ¯ Response cache headers"></a>å“åº”å¤´ä¿¡æ¯ Response cache headers</h3><ul>
<li><strong>Last-Modified</strong>:èµ„æºæœ€è¿‘ä¿®æ”¹æ—¶é—´</li>
<li><strong>Etag</strong>:ï¼ˆEntity tagç¼©å†™ï¼‰æ˜¯è¯·æ±‚èµ„æºçš„æ ‡è¯†ç¬¦ï¼Œä¸»è¦ç”¨äºåŠ¨æ€ç”Ÿæˆã€æ²¡æœ‰Last-Modifiedå€¼çš„èµ„æºã€‚</li>
<li><strong>Cache-Control</strong>:ç¼“å­˜æ§åˆ¶ï¼Œåªæœ‰åŒ…å«æ­¤è®¾ç½®å¯èƒ½ä½¿ç”¨é»˜è®¤ç¼“å­˜ç­–ç•¥ã€‚å¯èƒ½åŒ…å«å¦‚ä¸‹é€‰é¡¹ï¼š<br>  <strong>max-age</strong>ï¼šç¼“å­˜æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ã€‚<br>  <strong>public</strong>ï¼šå¯ä»¥è¢«ä»»ä½•åŒºç¼“å­˜ï¼ŒåŒ…æ‹¬ä¸­é—´ç»è¿‡çš„ä»£ç†æœåŠ¡å™¨ä¹Ÿå¯ä»¥ç¼“å­˜ã€‚é€šå¸¸ä¸ä¼šè¢«ä½¿ç”¨ï¼Œå› ä¸º    max-ageå·²ç»è¡¨ç¤ºæ­¤å“åº”å¯ä»¥ç¼“å­˜ã€‚<br>  <strong>private</strong>:åªèƒ½è¢«å½“å‰å®¢æˆ·ç«¯ç¼“å­˜ï¼Œä¸­é—´ä»£ç†æ— æ³•è¿›è¡Œç¼“å­˜ã€‚<br>  <strong>no-cache</strong>:å¿…é¡»ä¸æœåŠ¡å™¨ç«¯ç¡®è®¤å“åº”æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–åˆ™å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™ä½¿ç”¨æ–°è¯·æ±‚çš„å“åº”ã€‚<br>  <strong>no-store</strong>:ç¦æ­¢ä½¿ç”¨ç¼“å­˜</li>
<li><strong>Vary</strong>:å†³å®šå¦‚ä½•å†³å®šè¯·æ±‚æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Œé€šå¸¸ç”¨äºç¼“å­˜keyå”¯ä¸€å€¼ç¡®å®šå› ç´ ï¼ŒåŒä¸€ä¸ªèµ„æºä¸åŒçš„Varyè®¾ç½®ä¼šè¢«ä½œä¸ºä¸¤ä¸ªç¼“å­˜èµ„æºï¼ˆæ³¨æ„ï¼ŒNSURLCacheä¼šå¿½ç•¥Varyè¯·æ±‚ç¼“å­˜ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šExpiresæ˜¯HTTP 1.0æ ‡å‡†ç¼“å­˜æ§åˆ¶ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œè¯·ä½¿ç”¨<em>Cache-Control:max-age</em>ä»£æ›¿ï¼Œç±»ä¼¼çš„è¿˜æœ‰Pragma:no-cacheå’ŒCache-Control:no-cacheã€‚æ­¤å¤–ï¼ŒRequest cache headersä¸­ä¹Ÿæ˜¯å¯ä»¥åŒ…å«Cache-Controlçš„ï¼Œä¾‹å¦‚å¦‚æœè®¾ç½®ä¸ºno-cacheåˆ™è¯´æ˜æ­¤æ¬¡è¯·æ±‚ä¸è¦ä½¿ç”¨ç¼“å­˜æ•°æ®ä½œä¸ºå“åº”ã€‚</p>
</blockquote>
<p>é»˜è®¤ç¼“å­˜ç­–ç•¥ä¸‹å½“å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶é¦–å…ˆä¼šæ£€æŸ¥æœ¬åœ°æ˜¯å¦åŒ…å«ç¼“å­˜ï¼Œå¦‚æœæœ‰ç¼“å­˜åˆ™ç»§ç»­æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆé€šè¿‡<em>Cache-Control:max-age</em>æˆ–è€…<em>Expires</em>ï¼‰ï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸåˆ™ç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®ã€‚å¦‚æœç¼“å­˜è¿‡æœŸäº†ï¼Œåˆ™å‘èµ·ä¸€ä¸ªè¯·æ±‚ç»™æœåŠ¡å™¨ç«¯ï¼Œæ­¤æ—¶æœåŠ¡å™¨ç«¯å¯¹æ¯”èµ„æº<em>Last-Modified</em>æˆ–è€…<em>Etags</em>(äºŒè€…éƒ½å­˜åœ¨çš„æƒ…å†µä¸‹ä¸‹å¦‚æœæœ‰ä¸€ä¸ªä¸åŒåˆ™è®¤ä¸ºç¼“å­˜å·²è¿‡æœŸ)ï¼Œå¦‚æœä¸åŒåˆ™è¿”å›æ–°æ•°æ®ï¼Œå¦åˆ™è¿”å›<em>304 Not Modified</em>ç»§ç»­ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆå®¢æˆ·ç«¯å¯ä»¥å†ä½¿ç”¨â€max-ageâ€ç§’ç¼“å­˜æ•°æ®ï¼‰ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥å‘ç°ï¼Œå®¢æˆ·ç«¯å‘é€ä¸å‘é€è¯·æ±‚ä¸»è¦çœ‹<em>max-age</em>æ˜¯å¦è¿‡æœŸï¼Œè€Œè¿‡æœŸåæ˜¯å¦ç»§ç»­è®¿é—®åˆ™éœ€è¦é‡æ–°å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯æ ¹æ®æƒ…å†µé€šçŸ¥å®¢æˆ·ç«¯æ˜¯å¦å¯ä»¥ç»§ç»­ä½¿ç”¨ç¼“å­˜ï¼ˆè¿™ä¸ªè¿‡ç¨‹æ˜¯å¿…é¡»è¯·æ±‚çš„ï¼Œåªæ˜¯è¿”å›ç»“æœå¯èƒ½æ˜¯200æˆ–è€…304ï¼‰ã€‚</p>
<p>æ¸…æ¥šäº†é»˜è®¤ç½‘ç»œåè®®ç¼“å­˜ç›¸å…³çš„è®¾ç½®ä¹‹åï¼Œè¦ä½¿ç”¨é»˜è®¤ç¼“å­˜å°±å¾ˆç®€å•äº†ï¼Œé€šå¸¸å¯¹äºNSURLSessionä½ ä¸åšä»»ä½•è®¾ç½®ï¼Œåªè¦æœåŠ¡å™¨ç«¯å“åº”å¤´éƒ¨åŠ ä¸ŠCache-Control:max-age:xxxå°±å¯ä»¥ä½¿ç”¨ç¼“å­˜äº†ã€‚ä¸‹é¢Demo3ä¸­æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä½¿ç”¨NSURLSessioné€šè¿‡max-ageè¿›è¡Œä¸ºæœŸ60sçš„ç¼“å­˜ï¼Œè¿è¡Œä¼šå‘ç°åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚ä¹‹å60så†…ä¸ä¼šè¿›è¡Œå†æ¬¡è¯·æ±‚ï¼Œ60såæ‰ä¼šå‘èµ·ç¬¬äºŒæ¬¡è¯·æ±‚ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> config = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line"><span class="comment">// urlCacheé»˜è®¤ä½¿ç”¨ç§æœ‰å†…å­˜ç¼“å­˜</span></span><br><span class="line"><span class="comment">// config.urlCache = URLCache(memoryCapacity: 5*1024*1024, diskCapacity: 20*1024*1024, diskPath: nil)</span></span><br><span class="line"><span class="comment">// config.requestCachePolicy = .useProtocolCachePolicy</span></span><br><span class="line"><span class="keyword">let</span> urlSession = <span class="type">URLSession</span>(configuration: config)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"http://myapi.applinzi.com/url-cache/default-cache.php"</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dataTask = urlSession.dataTask(with: url, completionHandler: &#123; (data, response, error) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> tempError = error &#123;</span><br><span class="line">                    <span class="built_in">debugPrint</span>(tempError)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> tempData = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                    <span class="keyword">let</span> responseText = <span class="type">String</span>(data: tempData, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line">                    <span class="built_in">debugPrint</span>(responseText ?? <span class="string">"no text"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            dataTask.resume()</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨ç«¯default-cache.phpå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$time=time();</span><br><span class="line">	$interval=<span class="number">60</span>;</span><br><span class="line">	header(<span class="string">'Last-Modified: '</span>.gmdate(<span class="string">'r'</span>,$time));</span><br><span class="line">	header(<span class="string">'Expires: '</span>.gmdate(<span class="string">'r'</span>,($time+$interval)));</span><br><span class="line">	header(<span class="string">'Cache-Control: max-age='</span>.$interval);</span><br><span class="line">	header(<span class="string">'Content-type: text/json'</span>);</span><br><span class="line"></span><br><span class="line">	$arr = <span class="keyword">array</span>(<span class="string">'a'</span>=&gt;<span class="number">1</span>,<span class="string">'b'</span>=&gt;<span class="number">2</span>);</span><br><span class="line"> 	<span class="keyword">echo</span> json_encode($arr);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„è¯·æ±‚å’Œç›¸åº”å¤´ä¿¡æ¯å¦‚ä¸‹,æœåŠ¡å™¨ç«¯è®¾ç½®ç¼“å­˜60sï¼š</p>
<p><img src="/media/URLSession_DefaultCache_Headers.png" alt="URLSession_DefaultCache_Headers"></p>
<p>å½“ç„¶ï¼Œé…åˆæœåŠ¡å™¨ç«¯ä½¿ç”¨ç¼“å­˜æ˜¯ä¸€ç§ä¸é”™çš„æ–¹æ¡ˆï¼Œè‡ªç„¶å®˜æ–¹è®¾è®¡æ—¶ä¹Ÿæ˜¯å¸Œæœ›å°½å¯èƒ½ä½¿ç”¨é»˜è®¤ç¼“å­˜ç­–ç•¥ã€‚ä½†æ˜¯æœ‰äº›æ—¶å€™æœåŠ¡å™¨ç«¯å‡ºäºå…¶ä»–åŸå› è€ƒè™‘ï¼Œæˆ–è€…è¯´æˆ–å®¢æˆ·ç«¯éœ€è¦è‡ªå®šä¹‰ç¼“å­˜ç­–ç•¥æ—¶è¿˜æ˜¯æœ‰å¿…è¦è¿›è¡Œæ‰‹åŠ¨ç¼“å­˜ç®¡ç†çš„ã€‚æ¯”å¦‚è¯´å¦‚æœæœåŠ¡å™¨ç«¯æ ¹æœ¬æ²¡æœ‰è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´æˆ–è€…æœåŠ¡å™¨ç«¯æ ¹æœ¬æ— æ³•è·çŸ¥ç”¨æˆ·ä½•æ—¶æ¸…ç†ç¼“å­˜ã€ä½•æ—¶ä½¿ç”¨ç¼“å­˜è¿™äº›å…·ä½“é€»è¾‘ç­‰éƒ½éœ€è¦æœåŠ¡å™¨ç«¯è‡ªè¡Œåˆ¶å®šç¼“å­˜ç­–ç•¥ã€‚æœ‰ä¸å°‘æœ‹å‹é€‰æ‹©è‡ªå»ºæ•°æ®åº“ç›´æ¥ç¼“å­˜JSONæ¨¡å‹ï¼ˆé€šå¸¸æ˜¯NSArrayæˆ–è€…NSDictionaryï¼‰æˆ–è€…ç¼“å­˜æˆå½’æ¡£æ–‡ä»¶ç­‰ï¼Œå…¶å®ä½¿ç”¨NSURLCacheé»˜è®¤çš„ç¼“å­˜ç­–ç•¥ä¾ç„¶å¯è¡Œï¼Œåªæ˜¯éœ€è¦ä½¿ç”¨ç›¸å…³çš„ä»£ç†æ–¹æ³•ã€æ§åˆ¶ç¼“å­˜é€»è¾‘ï¼š</p>
<p>å¯¹äºNSURLConnnectionè€Œè¨€å¯ä»¥é€šè¿‡<code>- (NSCachedURLResponse *)connection:(NSURLConnection *)connection  willCacheResponse:(NSCachedURLResponse *)cachedResponse</code>è¿›è¡ŒäºŒæ¬¡ç¼“å­˜è®¾ç½®ï¼Œå¦‚æœæ­¤æ–¹æ³•è¿”å›nilåˆ™ä¸è¿›è¡Œç¼“å­˜ï¼Œé»˜è®¤ä¸å®ç°è¿™ä¸ªä»£ç†åˆ™ä¼šèµ°é»˜è®¤ç¼“å­˜ç­–ç•¥ã€‚è€ŒURLSessionDataDelegateä¹Ÿæœ‰ä¸€ä¸ªç±»ä¼¼çš„æ–¹æ³•æ˜¯<code>func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, willCacheResponse proposedResponse: CachedURLResponse, completionHandler: @escaping (CachedURLResponse?) -&gt; Swift.Void)</code>ï¼Œå®ƒçš„ä½¿ç”¨å’ŒNSURLConnectionæ˜¯ç±»ä¼¼çš„ï¼Œä¸åŒçš„æ˜¯<code>dataTask(with url: URL, completionHandler: @escaping (Data?, URLResponse?, Error?) -&gt; Swift.Void)</code>ç­‰ä¸€ç³»åˆ—å¸¦æœ‰completionHandlerçš„æ–¹æ³•å¹¶ä¸ä¼šèµ°ä»£ç†æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹<code>func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, willCacheResponse proposedResponse: CachedURLResponse, completionHandler: @escaping (CachedURLResponse?) -&gt; Swift.Void)</code>ä¹Ÿæ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œä½¿ç”¨æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚</p>
<p>äº‹å®ä¸Šæ— è®ºURLSessionèµ°ç¼“å­˜ç›¸å…³çš„ä»£ç†ï¼Œè¿˜æ˜¯é€šè¿‡completionHandlerè¿›è¡Œå›è°ƒï¼Œé»˜è®¤éƒ½ä¼šä½¿ç”¨NSURLCacheè¿›è¡Œç¼“å­˜ï¼Œæ— éœ€åšä»»ä½•å·¥ä½œã€‚ä¾‹å¦‚Demo3ä¸­çš„ç¤ºä¾‹2ã€3éƒ½éƒ½æ‰“å°å‡ºäº†é»˜è®¤çš„ç¼“å­˜ä¿¡æ¯ï¼Œä¸è¿‡å¦‚æœæœåŠ¡å™¨ç«¯ä¸è¿›è¡Œç¼“å­˜è®¾ç½®çš„è¯ï¼ˆheaderä¸­è®¾ç½®Cache-Controlï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹NSURLSessionæ˜¯ä¸ä¼šä½¿ç”¨ç¼“å­˜æ•°æ®çš„ã€‚å¦‚æœå°†ç¼“å­˜ç­–ç•¥è®¾ç½®ä¸ºä¼˜å…ˆè€ƒè™‘ç¼“å­˜ä½¿ç”¨ï¼ˆä¾‹å¦‚ä½¿ç”¨ï¼š<strong>.returnCacheDataElseLoad</strong>ï¼‰ï¼Œåˆ™å¯ä»¥çœ‹åˆ°ä¸‹æ¬¡è¯·æ±‚ä¸ä¼šå†å‘é€è¯·æ±‚ï¼ŒDemo3ä¸­çš„ç¤ºä¾‹4æ¼”ç¤ºäº†è¿™ä¸€æƒ…å†µã€‚ä¸è¿‡ä¸€æ—¦å¦‚æ­¤è®¾ç½®ä¹‹åä»¥åæƒ³è¦æ›´æ–°ç¼“å­˜å°±å˜å¾—è‰°éš¾äº†ï¼Œå› ä¸ºåªè¦ä¸æ¸…ç©ºç¼“å­˜æˆ–è¶…è¿‡ç¼“å­˜é™åˆ¶ï¼Œç¼“å­˜æ•°æ®å°±ä¸€ç›´å­˜åœ¨ï¼Œè€Œä¸”åœ¨åº”ç”¨ä¸­éšæ—¶æ¢åˆ‡æ¢ç¼“å­˜ç­–ç•¥æˆæœ¬ä¹Ÿå¹¶ä¸ä½ã€‚å› æ­¤ï¼Œè¦åˆç†åˆ©ç”¨ç³»ç»Ÿé»˜è®¤ç¼“å­˜çš„å‡ºå‘ç‚¹è¿˜æ˜¯åº”è¯¥ç€çœ¼åœ¨é»˜è®¤çš„åŸºäºç½‘ç»œåè®®çš„ç¼“å­˜è®¾ç½®ï¼Œå› ä¸ºä½¿ç”¨è¿™ä¸ªç¼“å­˜ç­–ç•¥åŸºæœ¬å·²ç»å¾ˆå®Œç¾äº†ã€‚</p>
<p>ä¸è¿‡è¿™æ ·ä¸€æ¥ç¼“å­˜çš„æ§åˆ¶é€»è¾‘å°±ä¸Šå‡ä¸ºè§£å†³ç¼“å­˜é—®é¢˜çš„é‡ç‚¹ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªAPIæ¥å£è®¾è®¡å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ç¼“å­˜ï¼Œä½†æ˜¯ä¸€æ—¦ç”¨æˆ·ä¿®æ”¹äº†éƒ¨åˆ†ä¿¡æ¯åˆ™å¸Œæœ›åŠæ—¶æ›´æ–°ä½¿ç”¨æœ€æ–°æ•°æ®ï¼Œä½†æ˜¯ç¼“å­˜ä¸è¿‡æœŸæœåŠ¡å™¨ç«¯å³ä½¿å¾ˆäº†è§£å®¢æˆ·ç«¯è®¾è®¡ä¹Ÿæ— æ³•åšåˆ°å¼ºåˆ¶æ›´æ–°ç¼“å­˜ï¼Œå› æ­¤å®¢æˆ·ç«¯å°±ä¸å¾—ä¸è‡ªè¡Œæ§åˆ¶ç¼“å­˜ã€‚é‚£ä¹ˆèƒ½ä¸èƒ½å¼ºåˆ¶NSURLCacheä½¿ç”¨ç½‘ç»œåè®®ç¼“å­˜ç­–ç•¥å‘¢ï¼Œå…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¯¹äºæœåŠ¡å™¨ç«¯æ²¡æœ‰æ·»åŠ cache headersæ§åˆ¶çš„å“åº”åªéœ€è¦æ·»åŠ ä¸Šå“åº”çš„ç¼“å­˜æ§åˆ¶å³å¯ã€‚Demo3çš„ç¤ºä¾‹5è¯´æ˜äº†è¿™ä¸€ç‚¹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoViewController3</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">requestWithServerCache1</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> config = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">        <span class="comment">// urlCacheé»˜è®¤ä½¿ç”¨ç§æœ‰å†…å­˜ç¼“å­˜</span></span><br><span class="line">        <span class="comment">// config.urlCache = URLCache(memoryCapacity: 5*1024*1024, diskCapacity: 20*1024*1024, diskPath: nil)</span></span><br><span class="line">        <span class="comment">// config.requestCachePolicy = .useProtocolCachePolicy</span></span><br><span class="line">        <span class="keyword">let</span> urlSession = <span class="type">URLSession</span>(configuration: config)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"http://myapi.applinzi.com/url-cache/default-cache.php"</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dataTask = urlSession.dataTask(with: url, completionHandler: &#123; (data, response, error) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> tempError = error &#123;</span><br><span class="line">                    <span class="built_in">debugPrint</span>(tempError)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> tempData = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                    <span class="keyword">let</span> responseText = <span class="type">String</span>(data: tempData, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line">                    <span class="built_in">debugPrint</span>(responseText ?? <span class="string">"no text"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            dataTask.resume()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">requestWithoutServerCache2</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> config = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">        <span class="keyword">let</span> urlSession = <span class="type">URLSession</span>(configuration: config, delegate: <span class="keyword">self</span>.delegate, delegateQueue: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"http://myapi.applinzi.com/url-cache/no-cache.php"</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dataTask = urlSession.dataTask(with: url)</span><br><span class="line">            dataTask.resume()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">requestWithoutServerCache3</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> config = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">        <span class="keyword">let</span> urlSession = <span class="type">URLSession</span>(configuration: config, delegate: <span class="keyword">self</span>, delegateQueue: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"http://myapi.applinzi.com/url-cache/no-cache.php"</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> urlRequest = <span class="type">URLRequest</span>(url: url)</span><br><span class="line">            <span class="keyword">let</span> dataTask = urlSession.dataTask(with: urlRequest, completionHandler: &#123; (data, response, error) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> tempError = error &#123;</span><br><span class="line">                    <span class="built_in">debugPrint</span>(tempError)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> tempData = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                    <span class="keyword">let</span> responseText = <span class="type">String</span>(data: tempData, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line">                    <span class="keyword">let</span> cacheResponse = <span class="type">URLCache</span>.shared.cachedResponse(<span class="keyword">for</span>: urlRequest)</span><br><span class="line">                    <span class="built_in">debugPrint</span>(cacheResponse)</span><br><span class="line">                    <span class="built_in">debugPrint</span>(responseText ?? <span class="string">"no text"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            dataTask.resume()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">requestWithoutServerCache4</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> config = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ç¼“å­˜æ•°æ®</span></span><br><span class="line">        config.requestCachePolicy = .returnCacheDataDontLoad</span><br><span class="line">        <span class="keyword">let</span> urlSession = <span class="type">URLSession</span>(configuration: config, delegate: <span class="keyword">self</span>, delegateQueue: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"http://myapi.applinzi.com/url-cache/no-cache.php"</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> urlRequest = <span class="type">URLRequest</span>(url: url)</span><br><span class="line">            <span class="keyword">let</span> dataTask = urlSession.dataTask(with: urlRequest, completionHandler: &#123; (data, response, error) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> tempError = error &#123;</span><br><span class="line">                    <span class="built_in">debugPrint</span>(tempError)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> tempData = data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                    <span class="keyword">let</span> responseText = <span class="type">String</span>(data: tempData, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line">                    <span class="keyword">let</span> cacheResponse = <span class="type">URLCache</span>.shared.cachedResponse(<span class="keyword">for</span>: urlRequest)</span><br><span class="line">                    <span class="built_in">debugPrint</span>(cacheResponse)</span><br><span class="line">                    <span class="built_in">debugPrint</span>(responseText ?? <span class="string">"no text"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            dataTask.resume()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">requestWithoutServerCache5</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> config = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">        <span class="keyword">let</span> urlSession = <span class="type">URLSession</span>(configuration: config, delegate: <span class="keyword">self</span>, delegateQueue: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"http://myapi.applinzi.com/url-cache/no-cache.php"</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dataTask = urlSession.dataTask(with: url)</span><br><span class="line">            dataTask.resume()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> delegate =  <span class="type">DemoViewController3Delegate</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DemoViewController3</span>:<span class="title">URLSessionDelegate</span>, <span class="title">URLSessionDataDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive data: Data)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> responseText = <span class="type">String</span>(data: data, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line">        <span class="built_in">debugPrint</span>(responseText ?? <span class="string">"no text"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, willCacheResponse proposedResponse: CachedURLResponse, completionHandler: @escaping <span class="params">(CachedURLResponse?)</span></span></span> -&gt; <span class="type">Swift</span>.<span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> httpResponse = proposedResponse.response <span class="keyword">as</span>? <span class="type">HTTPURLResponse</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> httpResponse.allHeaderFields[<span class="string">"Cache-Control"</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">let</span> newHeaders = (httpResponse.allHeaderFields <span class="keyword">as</span> <span class="type">NSDictionary</span>).mutableCopy() <span class="keyword">as</span>? <span class="type">NSDictionary</span></span><br><span class="line">                newHeaders?.setValue(<span class="string">"max-age=60"</span>, forKey: <span class="string">"Cache-Control"</span>)</span><br><span class="line">                <span class="keyword">let</span> newResponse = <span class="type">HTTPURLResponse</span>(url: httpResponse.url!, statusCode: httpResponse.statusCode, httpVersion: <span class="string">"HTTP/1.1"</span>, headerFields: newHeaders <span class="keyword">as</span>? [<span class="type">String</span> : <span class="type">String</span>])</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">let</span> newCacheResponse = <span class="type">CachedURLResponse</span>(response: newResponse!, data: proposedResponse.data)</span><br><span class="line">                completionHandler(newCacheResponse)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completionHandler(proposedResponse)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// for requestWithoutServerCache2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoViewController3Delegate</span>:<span class="title">NSObject</span>,<span class="title">URLSessionDelegate</span>, <span class="title">URLSessionDataDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive data: Data)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> responseText = <span class="type">String</span>(data: data, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line">        <span class="built_in">debugPrint</span>(responseText ?? <span class="string">"no text"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, willCacheResponse proposedResponse: CachedURLResponse, completionHandler: @escaping <span class="params">(CachedURLResponse?)</span></span></span> -&gt; <span class="type">Swift</span>.<span class="type">Void</span>) &#123;</span><br><span class="line">        completionHandler(proposedResponse)</span><br><span class="line">        <span class="built_in">debugPrint</span>(proposedResponse)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<h1 id="ç¼“å­˜è®¾è®¡"><a href="#ç¼“å­˜è®¾è®¡" class="headerlink" title="ç¼“å­˜è®¾è®¡"></a>ç¼“å­˜è®¾è®¡</h1><p>ä»å‰é¢å¯¹äº<strong>URL Loading System</strong>çš„åˆ†æå¯ä»¥çœ‹å‡ºåˆ©ç”¨NSURLProtocolæˆ–è€…NSURLCacheéƒ½å¯ä»¥åšå®¢æˆ·ç«¯ç¼“å­˜ï¼Œä½†æ˜¯NSURLProtocolæ›´å¤šçš„ç”¨äºæ‹¦æˆªå¤„ç†ï¼Œè€Œä¸”å¦‚æœä½¿ç”¨å®ƒæ¥åšç¼“å­˜çš„è¯éœ€è¦è‡ªå·±å‘èµ·è¯·æ±‚ã€‚è€Œé€‰æ‹©URLSessioné…åˆNSURLCacheçš„è¯ï¼Œåˆ™å¯¹äºæ¥å£è°ƒç”¨æ–¹æœ‰æ›´å¤šçµæ´»çš„æ§åˆ¶ï¼Œè€Œä¸”é»˜è®¤æƒ…å†µä¸‹NSURLCacheå°±æœ‰ç¼“å­˜ï¼Œæˆ‘ä»¬åªè¦æ“ä½œç¼“å­˜å“åº”çš„Cache headerså³å¯ï¼Œå› æ­¤åè€…ä½œä¸ºæˆ‘ä»¬ä¼˜å…ˆè€ƒè™‘çš„è®¾è®¡æ–¹æ¡ˆã€‚é‰´äºæœ¬æ–‡ä»£ç ä½¿ç”¨Swiftç¼–å†™ï¼Œå› æ­¤ç»“åˆç›®å‰Swiftä¸­æµè¡Œçš„ç½‘ç»œåº“Alamofireå®ç°ä¸€ç§ç›¸å¯¹ç®€å•çš„ç¼“å­˜æ–¹æ¡ˆã€‚</p>
<p>æ ¹æ®å‰é¢çš„æ€è·¯ï¼Œæœ€æ—©è¿˜æ˜¯æƒ³ä»URLSessionDataDelegateçš„ç¼“å­˜è®¾ç½®æ–¹æ³•å…¥æ‰‹ï¼Œè€Œä¸”Alamofireç¡®å®å¯¹äºæ¯ä¸ªURLSessionDataTaskéƒ½ç•™æœ‰ç¼“å­˜ä»£ç†æ–¹æ³•çš„å›è°ƒå…¥å£ï¼Œä½†æŸ¥çœ‹æºç å‘ç°è¿™ä¸ªå…¥å£<strong>dataTaskWillCacheResponse</strong>å¹¶æœªå¯¹å¤–å¼€å‘ï¼Œè€Œå¦‚æœç›´æ¥åœ¨SessionDelegateçš„å›è°ƒå…¥å£<strong>dataTaskWillCacheResponseWithCompletion</strong>ä¸Šè¿›è¡Œå›è°ƒåˆæ— æ³•æ§åˆ¶æ¯ä¸ªè¯·æ±‚çš„ç¼“å­˜æƒ…å†µï¼ˆNSURLSessionæ˜¯å¤šä¸ªè¯·æ±‚å…±ç”¨çš„ï¼‰ã€‚å½“ç„¶å¦‚æœæ²¿ç€è¿™ä¸ªæ€è·¯å¯ä»¥å†æ‰©å±•ä¸€ä¸ªDataTaskDelegateå¯¹è±¡ä»¥æš´æ¼ç¼“å­˜å…¥å£ï¼Œä½†æ˜¯è¿™ä¹ˆä¸€æ¥å¿…é¡»å®ç°URLSessionDataDelegate,è€Œä¸”è¦æƒ³åŠæ³•Swizzle NSURLSessionçš„ç¼“å­˜ä»£ç†(æˆ–è€…ç»§æ‰¿SessionDelegateåˆ‡æ¢ä»£ç†),åœ¨ä»£ç†ä¸­æ ¹æ®ä¸åŒçš„NSURLDataTaskè¿›è¡Œç¼“å­˜å¤„ç†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯¹äºè°ƒç”¨æ–¹å¹¶ä¸æ˜¯å¤ªå‹å¥½ã€‚</p>
<p>å¦ä¸€ä¸ªæ€è·¯å°±æ˜¯ç­‰Responseè¯·æ±‚ç»“æŸåè·å–ç¼“å­˜çš„å“åº”CachedURLResponseå¹¶ä¸”ä¿®æ”¹ï¼ˆäº‹å®ä¸Šåªè¦æ˜¯åŒä¸€ä¸ªNSURLRequestå­˜å‚¨è¿›å»é»˜è®¤ä¼šæ›´æ–°åŸæœ‰ç¼“å­˜ï¼‰ï¼Œè€Œä¸”NSURLCacheæœ¬èº«å°±æ˜¯æœ‰å†…å­˜ç¼“å­˜çš„ï¼Œè¿‡ç¨‹å¹¶ä¸ä¼šå¤ªè€—æ—¶ã€‚å½“ç„¶è¿™ä¸ªæ–¹æ¡ˆæœ€é‡è¦çš„æ˜¯å¾—ä¿è¯å“åº”å®Œæˆï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡Alamofireé“¾å¼è°ƒç”¨ä½¿ç”¨<strong>response(queue: queue, responseSerializer: responseSerializer, completionHandler: completionHandler</strong>é‡æ–°è¯·æ±‚ä»¥ä¿è¯åŠæ—¶æŒæ¡å›è°ƒæ—¶æœºã€‚ä¸»è¦çš„ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">cache</span><span class="params">(maxAge:Int,isPrivate:Bool = <span class="literal">false</span>,ignoreServer:Bool = <span class="literal">true</span>)</span></span></span><br><span class="line">    -&gt; <span class="type">Self</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> useServerButRefresh = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> newRequest = <span class="keyword">self</span>.request &#123;</span><br><span class="line">        <span class="keyword">if</span> !ignoreServer &#123;</span><br><span class="line">            <span class="keyword">if</span> newRequest.allHTTPHeaderFields?[<span class="type">AlamofireURLCache</span>.refreshCacheKey] == <span class="type">AlamofireURLCache</span>.<span class="type">RefreshCacheValue</span>.refreshCache.rawValue &#123;</span><br><span class="line">                useServerButRefresh = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> newRequest.allHTTPHeaderFields?[<span class="type">AlamofireURLCache</span>.refreshCacheKey] != <span class="type">AlamofireURLCache</span>.<span class="type">RefreshCacheValue</span>.refreshCache.rawValue &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> urlCache = <span class="keyword">self</span>.session.configuration.urlCache &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> value = (urlCache.cachedResponse(<span class="keyword">for</span>: newRequest)?.response <span class="keyword">as</span>? <span class="type">HTTPURLResponse</span>)?.allHeaderFields[<span class="type">AlamofireURLCache</span>.refreshCacheKey] <span class="keyword">as</span>? <span class="type">String</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> value == <span class="type">AlamofireURLCache</span>.<span class="type">RefreshCacheValue</span>.useCache.rawValue &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> response &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>](defaultResponse) <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> defaultResponse.request?.httpMethod != <span class="string">"GET"</span> &#123;</span><br><span class="line">            <span class="built_in">debugPrint</span>(<span class="string">"Non-GET requests do not support caching!"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> defaultResponse.error != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">debugPrint</span>(defaultResponse.error!.localizedDescription)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> httpResponse = defaultResponse.response &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> newRequest = defaultResponse.request <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> newData = defaultResponse.data <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> newURL = httpResponse.url <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> urlCache = <span class="keyword">self</span>.session.configuration.urlCache <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> newHeaders = (httpResponse.allHeaderFields <span class="keyword">as</span> <span class="type">NSDictionary</span>).mutableCopy() <span class="keyword">as</span>? <span class="type">NSMutableDictionary</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="type">AlamofireURLCache</span>.isCanUseCacheControl &#123;</span><br><span class="line">                <span class="keyword">if</span> httpResponse.allHeaderFields[<span class="string">"Cache-Control"</span>] == <span class="literal">nil</span> || httpResponse.allHeaderFields.keys.<span class="built_in">contains</span>(<span class="string">"no-cache"</span>) || httpResponse.allHeaderFields.keys.<span class="built_in">contains</span>(<span class="string">"no-store"</span>) || ignoreServer || useServerButRefresh &#123;</span><br><span class="line">                    <span class="type">DataRequest</span>.addCacheControlHeaderField(headers: newHeaders, maxAge: maxAge, isPrivate: isPrivate)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> httpResponse.allHeaderFields[<span class="string">"Expires"</span>] == <span class="literal">nil</span> || ignoreServer || useServerButRefresh &#123;</span><br><span class="line">                    <span class="type">DataRequest</span>.addExpiresHeaderField(headers: newHeaders, maxAge: maxAge)</span><br><span class="line">                    <span class="keyword">if</span> ignoreServer &amp;&amp; httpResponse.allHeaderFields[<span class="string">"Pragma"</span>] != <span class="literal">nil</span> &#123;</span><br><span class="line">                        newHeaders[<span class="string">"Pragma"</span>] = <span class="string">"cache"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            newHeaders[<span class="type">AlamofireURLCache</span>.refreshCacheKey] = <span class="type">AlamofireURLCache</span>.<span class="type">RefreshCacheValue</span>.useCache.rawValue</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> newResponse = <span class="type">HTTPURLResponse</span>(url: newURL, statusCode: httpResponse.statusCode, httpVersion: <span class="type">AlamofireURLCache</span>.<span class="type">HTTPVersion</span>, headerFields: newHeaders <span class="keyword">as</span>? [<span class="type">String</span> : <span class="type">String</span>]) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">let</span> newCacheResponse = <span class="type">CachedURLResponse</span>(response: newResponse, data: newData, userInfo: [<span class="string">"framework"</span>:<span class="type">AlamofireURLCache</span>.frameworkName], storagePolicy: <span class="type">URLCache</span>.<span class="type">StoragePolicy</span>.allowed)</span><br><span class="line">                </span><br><span class="line">                urlCache.storeCachedResponse(newCacheResponse, <span class="keyword">for</span>: newRequest)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦å®Œæˆæ•´ä¸ªç¼“å­˜å¤„ç†è‡ªç„¶è¿˜åŒ…æ‹¬ç¼“å­˜åˆ·æ–°ã€ç¼“å­˜æ¸…ç†ç­‰æ“ä½œï¼Œå…³äºç¼“å­˜æ¸…ç†æœ¬èº«NSURLCacheæ˜¯æä¾›äº†<em>remove</em>æ–¹æ³•çš„ï¼Œä¸è¿‡ç¼“å­˜æ¸…ç†å¹¶ä¸åŠæ—¶ï¼Œè°ƒç”¨å¹¶ä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼Œå…·ä½“å‚è§<a href="https://stackoverflow.com/questions/26260401/nsurlcache-does-not-clear-stored-responses-in-ios8" target="_blank" rel="external">NSURLCache does not clear stored responses in iOS8</a>ã€‚å› æ­¤ï¼Œè¿™é‡Œå€ŸåŠ©äº†ä¸Šé¢æåˆ°çš„<strong>Cache-Control</strong>è¿›è¡Œç¼“å­˜è¿‡æœŸæ§åˆ¶ï¼Œä¸€æ–¹é¢å¯ä»¥å¿«é€Ÿæ¸…ç†ç¼“å­˜ï¼Œå¦ä¸€æ–¹é¢ç¼“å­˜æ§åˆ¶å¯ä»¥æ›´åŠ ç²¾ç¡®ã€‚</p>
<h2 id="AlamofireURLCache"><a href="#AlamofireURLCache" class="headerlink" title="AlamofireURLCache"></a>AlamofireURLCache</h2><p><img src="/media/AlamofireURLCache_Logo.png" alt="AlamofireURLCache"></p>
<p>ä¸ºäº†æ›´å¥½çš„é…åˆAlamofireä½¿ç”¨ï¼Œæ­¤ä»£ç ä»¥<a href="https://github.com/kenshincui/AlamofireURLCache" target="_blank" rel="external">AlamofireURLCache</a>ç±»åº“å½¢å¼åœ¨githubå¼€æºï¼Œæ‰€æœ‰æ¥å£APIå°½é‡å’ŒåŸæœ‰æ¥å£ä¿æŒä¸€è‡´ï¼Œä¾¿äºå¯¹AlamofireäºŒæ¬¡å°è£…ã€‚æ­¤å¤–è¿˜æä¾›äº†æ‰‹åŠ¨æ¸…ç†ç¼“å­˜ã€å‡ºé”™ä¹‹åè‡ªåŠ¨æ¸…ç†ç¼“å­˜ã€è¦†ç›–æœåŠ¡å™¨ç«¯ç¼“å­˜é…ç½®ç­‰æ–¹ä¾¿çš„åŠŸèƒ½ï¼Œå¯ä»¥æ»¡è¶³å¤šæ•°æƒ…å†µä¸‹ç¼“å­˜éœ€æ±‚ç»†èŠ‚ã€‚</p>
<p>AlamofireURLCacheåœ¨requestæ–¹æ³•æ·»åŠ äº†<em>refreshCache</em>å‚æ•°ç”¨äºç¼“å­˜åˆ·æ–°ï¼Œè®¾ä¸ºfalseæˆ–è€…ä¸æä¾›æ­¤å‚æ•°åˆ™ä¸ä¼šåˆ·æ–°ç¼“å­˜ï¼Œåªæœ‰ç­‰åˆ°ä¸Šæ¬¡ç¼“å­˜æ•°æ®è¿‡äº†æœ‰æ•ˆæœŸæ‰ä¼šå†æ¬¡å‘èµ·è¯·æ±‚ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Alamofire</span>.request(<span class="string">"https://myapi.applinzi.com/url-cache/no-cache.php"</span>,refreshCache:<span class="literal">false</span>).responseJSON(completionHandler: &#123; response <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> response.value != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.textView.text = (response.value <span class="keyword">as</span>! [<span class="type">String</span>:<span class="type">Any</span>]).debugDescription</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.textView.text = <span class="string">"Error!"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;).cache(maxAge: <span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨ç«¯ç¼“å­˜headersè®¾ç½®å¹¶ä¸éƒ½æ˜¯æœ€ä¼˜é€‰æ‹©ï¼ŒæŸäº›æƒ…å†µä¸‹å®¢æˆ·ç«¯å¿…é¡»è‡ªè¡Œæ§åˆ¶ç¼“å­˜ç­–ç•¥ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨AlamofireURLCacheçš„<em>ignoreServer</em>å‚æ•°å¿½ç•¥æœåŠ¡å™¨ç«¯é…ç½®ï¼Œé€šè¿‡<em>maxAge</em>å‚æ•°è‡ªè¡Œæ§åˆ¶ç¼“å­˜æ—¶é•¿ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Alamofire</span>.request(<span class="string">"https://myapi.applinzi.com/url-cache/default-cache.php"</span>,refreshCache:<span class="literal">false</span>).responseJSON(completionHandler: &#123; response <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> response.value != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.textView.text = (response.value <span class="keyword">as</span>! [<span class="type">String</span>:<span class="type">Any</span>]).debugDescription</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.textView.text = <span class="string">"Error!"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;).cache(maxAge: <span class="number">10</span>,isPrivate: <span class="literal">false</span>,ignoreServer: <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>å¦å¤–ï¼Œæœ‰äº›æƒ…å†µä¸‹æœªå¿…éœ€è¦åˆ·æ–°ç¼“å­˜è€Œæ˜¯è¦æ¸…ç©ºç¼“å­˜ä¿è¯ä¸‹æ¬¡è®¿é—®æ—¶å†ä½¿ç”¨æœ€æ–°æ•°æ®ï¼Œæ­¤æ—¶å°±éœ€è¦ä½¿ç”¨AlamofireURLCacheæä¾›çš„ç¼“å­˜æ¸…ç†APIæ¥å®Œæˆã€‚éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œå¯¹äºè¯·æ±‚å‡ºé”™ã€åºåˆ—åŒ–å‡ºé”™ç­‰æƒ…å†µå¦‚æœè°ƒç”¨äº†<em>cache(maxAge)</em>æ–¹æ³•è¿›è¡Œç¼“å­˜åï¼Œé‚£ä¹ˆä¸‹æ¬¡è¯·æ±‚ä¼šä½¿ç”¨é”™è¯¯çš„ç¼“å­˜æ•°æ®ï¼Œéœ€è¦å¼€å‘äººå‘˜æ ¹æ®è¿”å›æƒ…å†µè‡ªè¡Œè°ƒç”¨APIæ¸…ç†ç¼“å­˜ã€‚ä½†æ›´å¥½çš„é€‰æ‹©æ˜¯ä½¿ç”¨AlamofireURLCacheæä¾›çš„<em>autoClearCache</em>å‚æ•°æ¥è‡ªåŠ¨å¤„ç†æ­¤ç§æƒ…å†µï¼Œæ‰€ä»¥ä»»ä½•æ—¶å€™éƒ½æ¨èå°†<em>autoClearCache</em>å‚æ•°è®¾ä¸ºtrueä»¥ä¿è¯ä¸ä¼šç¼“å­˜å‡ºé”™æ•°æ®ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Alamofire</span>.clearCache(dataRequest: dataRequest) <span class="comment">// clear cache by DataRequest</span></span><br><span class="line"><span class="type">Alamofire</span>.clearCache(request: urlRequest) <span class="comment">// clear cache by URLRequest</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ignore data cache when request error</span></span><br><span class="line"><span class="type">Alamofire</span>.request(<span class="string">"https://myapi.applinzi.com/url-cache/no-cache.php"</span>,refreshCache:<span class="literal">false</span>).responseJSON(completionHandler: &#123; response <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> response.value != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.textView.text = (response.value <span class="keyword">as</span>! [<span class="type">String</span>:<span class="type">Any</span>]).debugDescription</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.textView.text = <span class="string">"Error!"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;,autoClearCache:<span class="literal">true</span>).cache(maxAge: <span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>å¦‚æœé˜…è¯»æœ¬æ–‡è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œæ¬¢è¿æ¨èç‚¹èµï¼Œæœ€åå†æ¬¡é™„ä¸Šä»£ç ä¸‹è½½ï¼</p>
<p><a href="https://github.com/kenshincui/AlamofireURLCache#cache-and-refresh" target="_blank" rel="external">ä»£ç ä¸‹è½½</a></p>

  </section>

</article>

<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">æœ€è¿‘çš„æ–‡ç« </span>
                <h2 class="post-list__post-title post-title"><a href="/2020/01/13/iOSæ»¤é•œç³»åˆ—-æ»¤é•œå¼€å‘æ¦‚è§ˆ/" title="iOSæ»¤é•œç³»åˆ—-æ»¤é•œå¼€å‘æ¦‚è§ˆ">iOSæ»¤é•œç³»åˆ—-æ»¤é•œå¼€å‘æ¦‚è§ˆ</a></h2>
                <p class="excerpt">
                
                
æ¦‚è¿°æ»¤é•œæœ€æ—©çš„å‡ºç°åº”è¯¥æ˜¯åº”ç”¨åœ¨ç›¸æœºé•œå¤´å‰å®ç°è‡ªç„¶å…‰è¿‡æ»¤å’Œè°ƒè‰²çš„é•œç‰‡ï¼Œç„¶è€Œåœ¨è½¯ä»¶å¼€å‘ä¸­æ›´å¤šçš„æŒ‡çš„æ˜¯è½¯ä»¶æ»¤é•œï¼Œæ˜¯å¯¹é•œå¤´æ»¤é•œçš„æ¨¡æ‹Ÿå®ç°ã€‚å½“ç„¶è¿™ç§æ–¹å¼æ›´åŠ æ–¹ä¾¿å¿«æ·ï¼Œç¼ºç‚¹è‡ªç„¶å°±æ˜¯æ— æ³•è¿˜åŸæ‹æ‘„æ—¶çš„çœŸå®åœºæ™¯ï¼Œä¾‹å¦‚æ— æ³•å®ç°åå…‰é•œå’Œç´«å¤–çº¿æ»¤è‰²é•œçš„æ•ˆæœã€‚ä»Šå¤©ç®€å•ä»‹ç»ä¸€ä¸‹iOSæ»¤é•œå¼€å‘ä¸­çš„æ­£ç¡®å§¿åŠ¿ï¼Œè®©åˆšåˆšæ¥è§¦æ»¤é•œå¼€å‘çš„
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2020-01-13T07:53:20.000Z" class="post-list__meta--date date">2020-01-13</time> &#8226; <span class="post-list__meta--tags tags">äº&nbsp;
  <a class="tag-link" href="/tags/OpenGL-GPUImage-OpenCV-Core-Image-Metal/">OpenGL , GPUImage , OpenCV , Core Image , Metal</a>
</span><a class="btn-border-small" href="/2020/01/13/iOSæ»¤é•œç³»åˆ—-æ»¤é•œå¼€å‘æ¦‚è§ˆ/">ç»§ç»­é˜…è¯»</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">æ›´æ—©çš„æ–‡ç« </span>
                <h2 class="post-list__post-title post-title"><a href="/2017/05/08/iOSåˆ¨æ ¹é—®åº•-æ·±å…¥ç†è§£RunLoop/" title="iOSåˆ¨æ ¹é—®åº•-æ·±å…¥ç†è§£RunLoop">iOSåˆ¨æ ¹é—®åº•-æ·±å…¥ç†è§£RunLoop</a></h2>
                <p class="excerpt">
                
                æ¦‚è¿°RunLoopä½œä¸ºiOSä¸­ä¸€ä¸ªåŸºç¡€ç»„ä»¶å’Œçº¿ç¨‹æœ‰ç€åƒä¸ä¸‡ç¼•çš„å…³ç³»ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¾ˆå¤šå¸¸è§æŠ€æœ¯çš„å¹•ååŠŸè‡£ã€‚å°½ç®¡åœ¨å¹³æ—¶å¤šæ•°å¼€å‘è€…å¾ˆå°‘ç›´æ¥ä½¿ç”¨RunLoopï¼Œä½†æ˜¯ç†è§£RunLoopå¯ä»¥å¸®åŠ©å¼€å‘è€…æ›´å¥½çš„åˆ©ç”¨å¤šçº¿ç¨‹ç¼–ç¨‹æ¨¡å‹ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¸®åŠ©å¼€å‘è€…è§£ç­”æ—¥å¸¸å¼€å‘ä¸­çš„ä¸€äº›ç–‘æƒ‘ã€‚æœ¬æ–‡å°†ä»RunLoopæºç ç€æ‰‹ï¼Œç»“åˆRunL
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2017-05-08T03:05:23.000Z" class="post-list__meta--date date">2017-05-08</time> &#8226; <span class="post-list__meta--tags tags">äº&nbsp;
  <a class="tag-link" href="/tags/RunLoop/">RunLoop</a>
</span><a class="btn-border-small" href="/2017/05/08/iOSåˆ¨æ ¹é—®åº•-æ·±å…¥ç†è§£RunLoop/">ç»§ç»­é˜…è¯»</a></div>
                       
            </div>
        
     
   
   
  
</section>

  
<section class="post-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'kenshincui'; 
      
  var disqus_identifier = '/2017/06/05/iOSæ¶æ„è®¾è®¡-URLç¼“å­˜/';
  var disqus_title = 'iOSæ¶æ„è®¾è®¡-URLç¼“å­˜';
  var disqus_url = 'http://yoursite.com/2017/06/05/iOSæ¶æ„è®¾è®¡-URLç¼“å­˜/';
  

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          //dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
          dsq.src = 'https://a.disquscdn.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


            <footer class="footer">
    <span class="footer__copyright">
        æœ¬ç«™ç‚¹é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®</a>
    </span>
    <span class="footer__copyright">
        åŸºäº <a href="http://hexo.io">Hexo</a> æ­å»ºï¼Œæ„Ÿè°¢ <a href="https://pages.github.com/">GitHub Pages</a> æä¾›å…è´¹çš„æ‰˜ç®¡æœåŠ¡
    </span>
    <span class="footer__copyright">
        &copy; 2020 - æœ¬ç«™ä½¿ç”¨ <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> ä¸»é¢˜,
        ç”±<a href="https://monniya.com ">@Monniya</a> ä¿®æ”¹è‡ª <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, åŸåˆ›å‡ºè‡ª<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
    </span>
    
</footer>


        </div>
    </div>

     
    


    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
