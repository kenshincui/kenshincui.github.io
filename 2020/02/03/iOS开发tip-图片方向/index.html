<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>iOS开发tip-图片方向 | Kenshin Cui&#39;s Blog</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="iOS Developer">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="iOS开发tip-图片方向 | Kenshin Cui&#39;s Blog">
    <meta name="twitter:description" content="iOS Developer">

    <meta property="og:type" content="article">
    <meta property="og:title" content="iOS开发tip-图片方向 | Kenshin Cui&#39;s Blog">
    <meta property="og:description" content="iOS Developer">

    
    <meta name="author" content="Kenshin Cui">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/favicon.ico">
    

    <meta name="generator" content="hexo"/>
    

    <link rel="canonical" href="http://yoursite.com/2020/02/03/iOS开发tip-图片方向/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 Kenshin Cui&#39;s Blog 的主页"><img src="/images/avatar.jpg" width="80" alt="Kenshin Cui&#39;s Blog logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Kenshin Cui&#39;s Blog">Kenshin Cui&#39;s Blog</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">即便是别人看不到的地方, 对其工艺也必须尽心尽力。</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">iOS Developer</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
            
              <li class="navigation__item"><a href="/archive">归档</a></li>
            
              <li class="navigation__item"><a href="/about">关于</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/kenshincui" title="查看我的GitHub主页" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-green"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2020-02-03T10:23:20.000Z" class="post-list__meta--date date">2020-02-03</time> &#8226; <span class="post-meta__tags tags">于&nbsp;
  <a class="tag-link" href="/tags/UIImageOrientation-Exif/">UIImageOrientation , Exif</a>
 </span>
      <span class="page-pv">
      &nbsp;阅读&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">iOS开发tip-图片方向</h1>
  </header>

  <section class="post">
    <p><img src="https://i.loli.net/2020/02/03/9UcYEgxiVrZ3LR4.jpg" alt="image_meta_orientqtion"></p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>相信稍微接触过iOS图片相关操作的同学都遇到过图片旋转的问题，另外使用<a href="https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/capturing_still_and_live_photos" target="_blank" rel="external">AVFoundation</a>进行拍照的话就会遇到前后摄像头切换<a href="https://developer.apple.com/documentation/avfoundation/avcaptureconnection/1389172-isvideomirrored" target="_blank" rel="external">mirror</a>问题就让人更摸不着头脑了。今天就简单和大家聊一下iOS的图片方向问题。</p>
<h1 id="元数据Meta"><a href="#元数据Meta" class="headerlink" title="元数据Meta"></a>元数据Meta</h1><p>在拍照过程中相机可以旋转到各个方向拍摄，但是最终展示的照片应该都是符合我们查看习惯的，比如你拿起手机不管竖着拍、横着拍还是倒着拍最后查看的时候都是正过来的图片，这才符合我们的习惯。但是无论是相机还是手机光学元件都是固定的，不可能镜头和传感器真正的旋转，要是要实现这个依靠的是相机的传感器并且将方向信息写入图片的Meta数据中（有些文章会描述为Exif，其实Meta中还有其他信息，本文全部描述为Meta），并且在真正展示时纠正过来。当然展示一张照片通常不用我们自己处理但是一旦不了解这个信息在处理一张照片后可能就出问题了，比如说常见的Meta丢失。</p>
<p>先看一下<code>UIImage.imageOrientation</code>枚举值：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Orientation</span> : <span class="title">Int</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> up <span class="comment">// 图片方向朝上，如果iPhone拍摄手机需要逆时针旋转90度（前置摄像头的话则顺时针旋转90度)</span></span><br><span class="line">    <span class="keyword">case</span> down <span class="comment">// 图片旋转180度，如果iPhone拍摄手机需要顺时针旋转90度(前置摄像头的话则逆时针90度)</span></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">left</span> <span class="comment">// 图片顺时针旋转90度，如果iPhone拍摄手机需要旋转180度（前置摄像头的话也是如此）</span></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">right</span> <span class="comment">// 图片逆时针旋转90度，如果iPhone拍摄手机竖屏即可（前置摄像头的话也是如此)</span></span><br><span class="line">    <span class="keyword">case</span> upMirrored <span class="comment">// 图片水平镜像</span></span><br><span class="line">    <span class="keyword">case</span> downMirrored <span class="comment">// 图片旋转180度后水平镜像 </span></span><br><span class="line">    <span class="keyword">case</span> leftMirrored <span class="comment">// 图片逆时针旋转90度后垂直镜像</span></span><br><span class="line">    <span class="keyword">case</span> rightMirrored <span class="comment">// 图片顺时针旋转90度后垂直镜像 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于UIImage.imageOrientation可以使用图片说明更加详细：</p>
<p><img src="https://i.loli.net/2020/02/03/37qD2kB5jWcyNHO.jpg" alt="-w263"></p>
<p>注意<code>up</code>并非手机的竖屏<code>UIDeviceOrientation.portrait</code>模式拍摄的，因为这些参数其实都是相对相机传感器而来的。另外图片的方向和手机拍摄对应关系上面已经注释清楚了，值得一提的是并非前置摄像头就对应下面记得带<code>mirrored</code>方向。<br>比如一张图<code>UIImage.imageOrientation == UIImage.Orientation.right</code>说明本身逆时针旋转了90度，自然显示时需要顺时针旋转90度。</p>
<p><img src="https://i.loli.net/2020/02/03/nA2DukEOZxIvwcW.jpg" alt="iPhone11ProMax_Sample"></p>
<p>首先看一张iPhone 11 Pro Max拍摄的样张（注意不要压缩，话说在互联网找到这样一张带有正确方向的图片还真不容易，这里借用一张网上的图片，如果有版权问题作者请留言必删），然后我们可以使用下面的代码读取到Meta（或Exif）和imageOrientation信息如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> url = <span class="type">Bundle</span>.main.url(forResource: <span class="string">"iPhoneXR_Portrait"</span>, withExtension: <span class="string">"jpg"</span>) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">try</span> <span class="type">Data</span>(contentsOf: url)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> cgimage = <span class="type">CGImageSourceCreateWithData</span>(data <span class="keyword">as</span> <span class="type">CFData</span>, <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> attr = <span class="type">CGImageSourceCopyPropertiesAtIndex</span>(cgimage, <span class="number">0</span>, <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> image = <span class="type">UIImage</span>(data:data) &#123;</span><br><span class="line">                    <span class="built_in">debugPrint</span>(<span class="string">"ImageOrientation:<span class="subst">\(String(describing: image.imageOrientation.rawValue)</span>)"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">debugPrint</span>(<span class="string">"MetaInfo:"</span>)</span><br><span class="line">                <span class="built_in">debugPrint</span>(attr <span class="keyword">as</span> <span class="type">NSDictionary</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"error:<span class="subst">\(error.localizedDescription)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<details><br>  <summary style="color:#FF0000">打印内容比较长，点击查看打印结果</summary><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">&quot;ImageOrientation:3&quot;</span><br><span class="line">&quot;MetaInfo:&quot;</span><br><span class="line">&#123;</span><br><span class="line">    ColorModel = RGB;</span><br><span class="line">    DPIHeight = 72;</span><br><span class="line">    DPIWidth = 72;</span><br><span class="line">    Depth = 8;</span><br><span class="line">    Orientation = 6;</span><br><span class="line">    PixelHeight = 3024;</span><br><span class="line">    PixelWidth = 4032;</span><br><span class="line">    ProfileName = &quot;Display P3&quot;;</span><br><span class="line">    &quot;&#123;Exif&#125;&quot; =     &#123;</span><br><span class="line">        ApertureValue = &quot;1.69599381283836&quot;;</span><br><span class="line">        BrightnessValue = &quot;9.252236963900032&quot;;</span><br><span class="line">        ComponentsConfiguration =         (</span><br><span class="line">            1,</span><br><span class="line">            2,</span><br><span class="line">            3,</span><br><span class="line">            0</span><br><span class="line">        );</span><br><span class="line">        DateTimeDigitized = &quot;2019:06:28 18:45:43&quot;;</span><br><span class="line">        DateTimeOriginal = &quot;2019:06:28 18:45:43&quot;;</span><br><span class="line">        ExifVersion =         (</span><br><span class="line">            2,</span><br><span class="line">            2,</span><br><span class="line">            1</span><br><span class="line">        );</span><br><span class="line">        ExposureBiasValue = 0;</span><br><span class="line">        ExposureMode = 0;</span><br><span class="line">        ExposureProgram = 2;</span><br><span class="line">        ExposureTime = &quot;0.00103950103950104&quot;;</span><br><span class="line">        FNumber = &quot;1.8&quot;;</span><br><span class="line">        Flash = 16;</span><br><span class="line">        FlashPixVersion =         (</span><br><span class="line">            1,</span><br><span class="line">            0</span><br><span class="line">        );</span><br><span class="line">        FocalLenIn35mmFilm = 26;</span><br><span class="line">        FocalLength = &quot;4.25&quot;;</span><br><span class="line">        ISOSpeedRatings =         (</span><br><span class="line">            25</span><br><span class="line">        );</span><br><span class="line">        LensMake = ;</span><br><span class="line">        LensModel = &quot;iPhone XR back camera 4.25mm f/1.8&quot;;</span><br><span class="line">        LensSpecification =         (</span><br><span class="line">            &quot;4.25&quot;,</span><br><span class="line">            &quot;4.25&quot;,</span><br><span class="line">            &quot;1.8&quot;,</span><br><span class="line">            &quot;1.8&quot;</span><br><span class="line">        );</span><br><span class="line">        MeteringMode = 5;</span><br><span class="line">        PixelXDimension = 4032;</span><br><span class="line">        PixelYDimension = 3024;</span><br><span class="line">        SceneCaptureType = 0;</span><br><span class="line">        SceneType = 1;</span><br><span class="line">        SensingMethod = 2;</span><br><span class="line">        ShutterSpeedValue = &quot;9.910588639093874&quot;;</span><br><span class="line">        SubjectArea =         (</span><br><span class="line">            2013,</span><br><span class="line">            1511,</span><br><span class="line">            2116,</span><br><span class="line">            1270</span><br><span class="line">        );</span><br><span class="line">        SubsecTimeDigitized = 354;</span><br><span class="line">        SubsecTimeOriginal = 354;</span><br><span class="line">        WhiteBalance = 0;</span><br><span class="line">    &#125;;</span><br><span class="line">    &quot;&#123;GPS&#125;&quot; =     &#123;</span><br><span class="line">        Altitude = &quot;14.96670574443142&quot;;</span><br><span class="line">        AltitudeRef = 0;</span><br><span class="line">        DateStamp = &quot;2019:06:28&quot;;</span><br><span class="line">        DestBearing = &quot;275.3164977571025&quot;;</span><br><span class="line">        DestBearingRef = T;</span><br><span class="line">        HPositioningError = &quot;6.852588686481304&quot;;</span><br><span class="line">        ImgDirection = &quot;275.3164977571025&quot;;</span><br><span class="line">        ImgDirectionRef = T;</span><br><span class="line">        Latitude = &quot;24.25116166666667&quot;;</span><br><span class="line">        LatitudeRef = N;</span><br><span class="line">        Longitude = &quot;118.0952083333333&quot;;</span><br><span class="line">        LongitudeRef = E;</span><br><span class="line">        Speed = &quot;0.110432714091527&quot;;</span><br><span class="line">        SpeedRef = K;</span><br><span class="line">        TimeStamp = &quot;10:45:42&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">    &quot;&#123;JFIF&#125;&quot; =     &#123;</span><br><span class="line">        DensityUnit = 0;</span><br><span class="line">        JFIFVersion =         (</span><br><span class="line">            1,</span><br><span class="line">            0,</span><br><span class="line">            1</span><br><span class="line">        );</span><br><span class="line">        XDensity = 72;</span><br><span class="line">        YDensity = 72;</span><br><span class="line">    &#125;;</span><br><span class="line">    &quot;&#123;MakerApple&#125;&quot; =     &#123;</span><br><span class="line">        1 = 10;</span><br><span class="line">        14 = 4;</span><br><span class="line">        2 = &#123;length = 512, bytes = 0x4e005100 5d006700 73007800 9800f800 ... c500c000 a0005f00 &#125;;</span><br><span class="line">        20 = 10;</span><br><span class="line">        23 = 0;</span><br><span class="line">        25 = 0;</span><br><span class="line">        26 = q825s;</span><br><span class="line">        3 =         &#123;</span><br><span class="line">            epoch = 0;</span><br><span class="line">            flags = 1;</span><br><span class="line">            timescale = 1000000000;</span><br><span class="line">            value = 315296098277500;</span><br><span class="line">        &#125;;</span><br><span class="line">        31 = 0;</span><br><span class="line">        33 = 0;</span><br><span class="line">        35 =         (</span><br><span class="line">            571,</span><br><span class="line">            268435846</span><br><span class="line">        );</span><br><span class="line">        37 = 386;</span><br><span class="line">        38 = 3;</span><br><span class="line">        39 = &quot;56.35717&quot;;</span><br><span class="line">        4 = 1;</span><br><span class="line">        40 = 1;</span><br><span class="line">        5 = 184;</span><br><span class="line">        6 = 189;</span><br><span class="line">        7 = 1;</span><br><span class="line">        8 =         (</span><br><span class="line">            &quot;0.001883197&quot;,</span><br><span class="line">            &quot;-0.8499792&quot;,</span><br><span class="line">            &quot;0.5379266&quot;</span><br><span class="line">        );</span><br><span class="line">    &#125;;</span><br><span class="line">    &quot;&#123;TIFF&#125;&quot; =     &#123;</span><br><span class="line">        DateTime = &quot;2019:06:28 18:45:43&quot;;</span><br><span class="line">        Make = ;</span><br><span class="line">        Model = &quot;iPhone XR&quot;;</span><br><span class="line">        Orientation = 6;</span><br><span class="line">        ResolutionUnit = 2;</span><br><span class="line">        Software = &quot;12.3.1&quot;;</span><br><span class="line">        TileLength = 512;</span><br><span class="line">        TileWidth = 512;</span><br><span class="line">        XResolution = 72;</span><br><span class="line">        YResolution = 72;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br></details>

<p>首先上面的照片的<code>imageOrientation=3</code>也就是right（逆时针旋转90度），可以计算出拍摄时手机是<code>portraint</code>竖屏拍摄的（哈哈，不是手机倒过来啊，可以测试）。如果说要正确展示其实应该顺时针旋转90度就可以了，浏览器本身是做了处理的，当然也有软件没有处理，比如当前博主的编辑器预览界面是这样的（如下：这里是截图），这是因为编辑器预览界面并没有正确处理造成的:首先编辑器并没有读取图片方向信息，而是按照图片的真实像素展示，理论上它应该读取图片方向然后顺时针旋转90度，但是因为并没有那么做而造成的。</p>
<p><img src="https://i.loli.net/2020/02/03/hQndml2M1S6eXD3.png" alt="iPhonePortrait_inEditor_screenshot"></p>
<p>尽管如此，上面的图片虽然<code>imageOrientation=3</code>，可是为什么<code>TIFF</code>中的<code>meta</code>信息为什么是<code>Orientation = 6</code>呢？两者又有什么关系呢？首先看一下<code>Exif</code>中的信息：</p>
<p><img src="https://i.loli.net/2020/02/03/aXM2CpsP1nJLA7e.gif" alt="exif_orientation"></p>
<p>其正确的方向可以通过上图看到，当然上面也少了imageOrientation中所得mirred方向，其实这个是通过翻转而来：</p>
<p><img src="https://i.loli.net/2020/02/03/Slna69ksErmiXc8.gif" alt="exif_orientation_flip"></p>
<p>关于<code>imageOrientation</code>和exif中的<code>orientation flag</code>两者有着一一对应的关系，但是值又是不同的，记住即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">            UIImage.imageOrientation     TIFF/IPTC kCGImagePropertyOrientation</span><br><span class="line"></span><br><span class="line">iPhone native     UIImageOrientationUp    = 0  =  Landscape left  = 1  </span><br><span class="line">rotate 180deg     UIImageOrientationDown  = 1  =  Landscape right = 3  </span><br><span class="line">rotate 90CCW      UIImageOrientationLeft  = 2  =  Portrait  down  = 8  </span><br><span class="line">rotate 90CW       UIImageOrientationRight = 3  =  Portrait  up    = 6</span><br></pre></td></tr></table></figure>
<blockquote>
<p>需要指出的是，无论是CGImage（这里并不是CGImageSource）、CIImage都是没有Meta的，UIImage可能有，但是即使有也是不全的。了解这个一点很重要，不然转化或者保存时Meta就丢失了。就拿上面的例子来说，我们打印Meta信息其实使用的是Data类型，这个Data是直接从文件（也可以是相册）读取的，如果你读取到的是UIImage然后转化成Data（比如说UIImage.pngData）此时查看Exif将会打印如下信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt;  &#123;</span><br><span class="line">&gt;     ColorModel = RGB;</span><br><span class="line">&gt;     Depth = 8;</span><br><span class="line">&gt;     PixelHeight = 3024;</span><br><span class="line">&gt;     PixelWidth = 4032;</span><br><span class="line">&gt;     ProfileName = &quot;Display P3&quot;;</span><br><span class="line">&gt;     &quot;&#123;Exif&#125;&quot; =     &#123;</span><br><span class="line">&gt;         PixelXDimension = 4032;</span><br><span class="line">&gt;         PixelYDimension = 3024;</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt;     &quot;&#123;PNG&#125;&quot; =     &#123;</span><br><span class="line">&gt;         InterlaceType = 0;</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>如果换成UIImage.jpegData(compressionQuality: 1.0)再打印可以看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;</span><br><span class="line">&gt;     ColorModel = RGB;</span><br><span class="line">&gt;     Depth = 8;</span><br><span class="line">&gt;     Orientation = 6;</span><br><span class="line">&gt;     PixelHeight = 3024;</span><br><span class="line">&gt;     PixelWidth = 4032;</span><br><span class="line">&gt;     ProfileName = &quot;Display P3&quot;;</span><br><span class="line">&gt;     &quot;&#123;Exif&#125;&quot; =     &#123;</span><br><span class="line">&gt;         ColorSpace = 65535;</span><br><span class="line">&gt;         PixelXDimension = 4032;</span><br><span class="line">&gt;         PixelYDimension = 3024;</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt;     &quot;&#123;JFIF&#125;&quot; =     &#123;</span><br><span class="line">&gt;         DensityUnit = 0;</span><br><span class="line">&gt;         JFIFVersion =         (</span><br><span class="line">&gt;             1,</span><br><span class="line">&gt;             0,</span><br><span class="line">&gt;             1</span><br><span class="line">&gt;         );</span><br><span class="line">&gt;         XDensity = 72;</span><br><span class="line">&gt;         YDensity = 72;</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt;     &quot;&#123;TIFF&#125;&quot; =     &#123;</span><br><span class="line">&gt;         Orientation = 6;</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>也就是说UIImage本身可能包含Exif但是不一定齐全，如果是pngData也并不会包含方向信息。但是还要提的是上面的UIImage是通过UIImage(data:XXX)创建的，如果通过CGImage或者CIImage创建则情况又不一样，不如说通过CGImage创建然后同样的方法打印(转化成UIImage.jpegData(compressionQuality: 1.0))，可以看到下面的Exif信息，方向已经不对了（注意如果保存这个图片方向是错误的）:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;</span><br><span class="line">&gt;     ColorModel = RGB;</span><br><span class="line">&gt;     Depth = 8;</span><br><span class="line">&gt;     Orientation = 1;</span><br><span class="line">&gt;     PixelHeight = 3024;</span><br><span class="line">&gt;     PixelWidth = 4032;</span><br><span class="line">&gt;     ProfileName = &quot;Display P3&quot;;</span><br><span class="line">&gt;     &quot;&#123;Exif&#125;&quot; =     &#123;</span><br><span class="line">&gt;         ColorSpace = 65535;</span><br><span class="line">&gt;         PixelXDimension = 4032;</span><br><span class="line">&gt;         PixelYDimension = 3024;</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt;     &quot;&#123;JFIF&#125;&quot; =     &#123;</span><br><span class="line">&gt;         DensityUnit = 0;</span><br><span class="line">&gt;         JFIFVersion =         (</span><br><span class="line">&gt;             1,</span><br><span class="line">&gt;             0,</span><br><span class="line">&gt;             1</span><br><span class="line">&gt;         );</span><br><span class="line">&gt;         XDensity = 72;</span><br><span class="line">&gt;         YDensity = 72;</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt;     &quot;&#123;TIFF&#125;&quot; =     &#123;</span><br><span class="line">&gt;         Orientation = 1;</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>所以总结起来Data、UIImage、CGImage、CIImage之间方向的传递并非对等，只有Data以及从Data创建的UIImage才能正确处理图片方向，其他情况均需要考虑方向问题。</p>
</blockquote>
<h1 id="操作Meta"><a href="#操作Meta" class="headerlink" title="操作Meta"></a>操作Meta</h1><p>既然搞清楚了图片方向的控制属性，那么其实要正确处理图片方向就不难了，当然你不要试图操作<code>imageOrientation</code>这个属性是<code>readonly</code>，正确的操作方式就是操作<code>orientation flag</code>。通常我们遇到图片不正确的情况多数是因为你编辑了图片没有正确的还原造成<code>orientation flag</code>的值和图片实际的像素排布不符造成的（人眼视觉认为图片像素起始行应该在上面，也就是up是正确的），比如下图中的<code>F</code>字样的图像，首先我们认为第一篇<code>F</code>型展示才是正确的而旋转倒过来都是不对的（比如看到 <span style="display:inline-block;transform:rotate(-90deg);-webkit-transform:rotate(-90deg);-moz-transform:rotate(-90deg);-ms-transform:rotate(-90deg); -o-transform:rotate(-90deg); ">F</span> 我们就认为显示有问题），这样配合<code>orientation flag</code>才能正确展示。</p>
<p><img src="https://i.loli.net/2020/02/03/nLDiFPKsMqvUgRe.jpg" alt="-w605"></p>
<p>了解了<strong>视觉<code>up</code></strong>正确性我们要解决拍照后由于使用滤镜或者编辑了图片后造成的图片方向问题就可以迎刃而解了。比如就拿上面的iPhone拍摄的照片来说，比如说你想加一个滤镜然后保存通常的处理方法可能是这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> path = <span class="type">Bundle</span>.main.path(forResource: <span class="string">"iPhoneXR_Portrait"</span>, ofType: <span class="string">"jpg"</span>) &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> originImage = <span class="type">UIImage</span>(contentsOfFile: path), <span class="keyword">let</span> cgImage = originImage.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> ciImage = <span class="type">CIImage</span>(cgImage: cgImage)</span><br><span class="line">    <span class="keyword">let</span> outputImage = ciImage.applyingFilter(<span class="string">"CIExposureAdjust"</span>, parameters: [<span class="string">"inputEV"</span>:<span class="number">0.6</span>])</span><br><span class="line">    <span class="keyword">let</span> context = <span class="type">CIContext</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> cgImage = context.createCGImage(outputImage, from: outputImage.extent) &#123;</span><br><span class="line">        <span class="keyword">let</span> image = <span class="type">UIImage</span>(cgImage: cgImage)</span><br><span class="line">        <span class="type">UIImageWriteToSavedPhotosAlbum</span>(image, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果方便运行代码可以在cgImage后面打个断点使用Xcode查看一下<code>cgImage</code>可以看是一张天空在左边的旋转图片，类似于上文提到的编辑器预览效果一样：</p>
<p><img src="https://i.loli.net/2020/02/03/hQndml2M1S6eXD3.png" alt="iPhonePortrait_inEditor_screenshot"></p>
<p>原因上面也提到过，这个因为CGImage没有exif信息，而<strong>视觉<code>up</code></strong>和相机保留的信息不同造成看起来<em>出错</em>。继续应用滤镜之后会发现保存起来的效果也是错误的：</p>
<p><img src="https://i.loli.net/2020/02/03/UbHLVrNS5stmMJ3.png" alt="filter_image_inalbu"></p>
<p>解决这个问题其实并不复杂，因为肯定Core Image框架开发者已经想到这个问题了，只需要在创建会UIImage时传入原图imageOrientation即可：</p>
<p><code>let image = UIImage(cgImage: cgImage, scale: 1.0, orientation: originImage.imageOrientation)</code></p>
<p>不过必须强调的是这种方式并非修改了<code>orientation flag</code>，还是没有exif信息的，只是把图片旋转过来达到<strong>视觉<code>up</code></strong>的效果。</p>
<p>那么有没有方式可以既保存修改后的图片又保存原始Exif呢？当然解决方式就是处理后再生成UIImage时不用传递<code>originImage.imageOrientation</code>，而是在生成后重新写入原始Meta信息即可。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> url = <span class="type">Bundle</span>.main.url(forResource: <span class="string">"iPhoneXR_Portrait"</span>, withExtension: <span class="string">"jpg"</span>) &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> originImageData = <span class="keyword">try</span>? <span class="type">Data</span>(contentsOf: url), <span class="keyword">let</span> originImage = <span class="type">UIImage</span>(data: originImageData), <span class="keyword">let</span> originCGImage = originImage.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">let</span> newData = <span class="type">UIImage</span>(cgImage: originCGImage).jpegData(compressionQuality: <span class="number">1.0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> metaInfo:<span class="type">NSDictionary</span>?</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> image = <span class="type">CGImageSourceCreateWithData</span>(newData! <span class="keyword">as</span> <span class="type">CFData</span>, <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> attr = <span class="type">CGImageSourceCopyPropertiesAtIndex</span>(image, <span class="number">0</span>, <span class="literal">nil</span>) &#123;</span><br><span class="line">            metaInfo = attr <span class="keyword">as</span> <span class="type">NSDictionary</span></span><br><span class="line">            <span class="built_in">print</span>(metaInfo)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">let</span> ciImage = <span class="type">CIImage</span>(cgImage: originCGImage)</span><br><span class="line">    <span class="keyword">let</span> outputImage = ciImage.applyingFilter(<span class="string">"CIExposureAdjust"</span>, parameters: [<span class="string">"inputEV"</span>:<span class="number">0.6</span>])</span><br><span class="line">    <span class="keyword">let</span> context = <span class="type">CIContext</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> filterCGImage = context.createCGImage(outputImage, from: outputImage.extent)&#123;</span><br><span class="line">        <span class="keyword">let</span> filterImage = <span class="type">UIImage</span>(cgImage: filterCGImage)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> filterImageData = filterImage.jpegData(compressionQuality: <span class="number">0.8</span>),<span class="keyword">let</span> compressImage = <span class="type">UIImage</span>(data: filterImageData) &#123; <span class="comment">// 压缩图片</span></span><br><span class="line">            <span class="keyword">let</span> data = <span class="type">NSMutableData</span>()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> imageDest = <span class="type">CGImageDestinationCreateWithData</span>(data <span class="keyword">as</span> <span class="type">CFMutableData</span>, kUTTypeJPEG, <span class="number">1</span>, <span class="literal">nil</span>),<span class="keyword">let</span> metaInfo = metaInfo &#123;</span><br><span class="line">                <span class="type">CGImageDestinationAddImage</span>(imageDest, compressImage.cgImage!, metaInfo)</span><br><span class="line">                <span class="type">CGImageDestinationFinalize</span>(imageDest)</span><br><span class="line">                <span class="type">PHPhotoLibrary</span>.shared().performChanges(&#123;</span><br><span class="line">                    <span class="keyword">let</span> creationRequest = <span class="type">PHAssetCreationRequest</span>.forAsset()</span><br><span class="line">                    creationRequest.addResource(with: <span class="type">PHAssetResourceType</span>.photo, data: newData <span class="keyword">as</span>! <span class="type">Data</span>, options: <span class="literal">nil</span>)</span><br><span class="line">                &#125;) &#123; (isSuccess, error) <span class="keyword">in</span></span><br><span class="line">                    <span class="keyword">if</span> isSuccess &#123;</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">"Save success..."</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码首先读取Meta保存到MetaInfo，然后给图片应用滤镜，最后通过<code>CGImageDestinationCreateWithData</code>将应用滤镜后的图片写入Meta信息，最后使用<code>PHPhotoLibrary</code>保存到相册。这里着重说一下保存时不要使用UIImage，比如上面<code>UIImageWriteToSavedPhotosAlbum(image, nil, nil, nil)</code>，因为上面说过UIImage并不包含完整的Exif。</p>
<blockquote>
<p>试一下下面的代码（修改<code>PHPhotoLibrary</code>保存照片的方式，直接保存UIImage）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; if let newImage = UIImage(data: data.copy() as! Data) &#123;</span><br><span class="line">&gt;     UIImageWriteToSavedPhotosAlbum(newImage, nil, nil, nil)</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以发现保存之后没有Meta信息，当然这并不是因为data中没有而是转化成UIImage以后丢失了，而<code>UIImageWriteToSavedPhotosAlbum(xxx)</code>并没有一个可以传Data类型的重载。比如可以试一下下面的方式应该可以正确保存Meta：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; if let newImage = UIImage(data: data.copy() as! Data) &#123;</span><br><span class="line">&gt;     let path = NSTemporaryDirectory() + &quot;1.jpg&quot;</span><br><span class="line">&gt;     let url = URL(fileURLWithPath: path)</span><br><span class="line">&gt;     do &#123;</span><br><span class="line">&gt;         try (data.copy() as? Data)?.write(to: url)</span><br><span class="line">&gt;     &#125; catch &#123;</span><br><span class="line">&gt;         print(&quot;error:\(error.localizedDescription)&quot;)</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="常用的fixOrientation"><a href="#常用的fixOrientation" class="headerlink" title="常用的fixOrientation"></a>常用的fixOrientation</h1><p>相信大家遇到图片旋转问题一搜索就会有下面一段代码出现（当然可能是OC版本）：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">fixOrientation</span><span class="params">()</span></span> -&gt; <span class="type">UIImage</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> imageOrientation == .up &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="type">UIGraphicsBeginImageContextWithOptions</span>(size, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">    draw(<span class="keyword">in</span>: <span class="type">CGRect</span>(origin: <span class="type">CGPoint</span>.zero, size: size))</span><br><span class="line">    <span class="keyword">let</span> processdImage = <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="type">UIGraphicsEndImageContext</span>()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> processdImage ?? <span class="keyword">self</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先说明这种方式并不能保存Exif信息，如果没有保存Meta的需求通常可以直接解决问题，之所以可以修正图片的方向本质是什么呢？了解这些才能正确的运用这个方法。比如下面的代码其实是不能正确修复方向信息的：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> path = <span class="type">Bundle</span>.main.path(forResource: <span class="string">"iPhoneXR_Portrait"</span>, ofType: <span class="string">"jpg"</span>) &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> originImage = <span class="type">UIImage</span>(contentsOfFile: path), <span class="keyword">let</span> cgImage = originImage.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> ciImage = <span class="type">CIImage</span>(cgImage: cgImage)</span><br><span class="line">    <span class="keyword">let</span> outputImage = ciImage.applyingFilter(<span class="string">"CIExposureAdjust"</span>, parameters: [<span class="string">"inputEV"</span>:<span class="number">0.6</span>])</span><br><span class="line">    <span class="keyword">let</span> context = <span class="type">CIContext</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> cgImage = context.createCGImage(outputImage, from: outputImage.extent) &#123;</span><br><span class="line">        <span class="keyword">let</span> image = <span class="type">UIImage</span>(cgImage: cgImage)</span><br><span class="line">        <span class="keyword">let</span> newImage = image.fixOrientation()</span><br><span class="line">        <span class="type">UIImageWriteToSavedPhotosAlbum</span>(newImage, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么正确的用法是什么呢？</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> path = <span class="type">Bundle</span>.main.path(forResource: <span class="string">"iPhoneXR_Portrait"</span>, ofType: <span class="string">"jpg"</span>) &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> originImage = <span class="type">UIImage</span>(contentsOfFile: path)?.fixOrientation(), <span class="keyword">let</span> cgImage = originImage.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> ciImage = <span class="type">CIImage</span>(cgImage: cgImage)</span><br><span class="line">    <span class="keyword">let</span> outputImage = ciImage.applyingFilter(<span class="string">"CIExposureAdjust"</span>, parameters: [<span class="string">"inputEV"</span>:<span class="number">0.6</span>])</span><br><span class="line">    <span class="keyword">let</span> context = <span class="type">CIContext</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> cgImage = context.createCGImage(outputImage, from: outputImage.extent) &#123;</span><br><span class="line">        <span class="keyword">let</span> image = <span class="type">UIImage</span>(cgImage: cgImage)</span><br><span class="line">        <span class="type">UIImageWriteToSavedPhotosAlbum</span>(image, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为fixOrientation()方法本身并非修改了图片信息而是将图片修改为<strong>视觉<code>up</code></strong>并且移除Meta中的方向信息，前面的代码不能正确修复的原因是图片已经没有Meta信息了，它也就不能正确修正了。</p>
<blockquote>
<blockquote>
<p>还有另一个版本的fixOrientation是通过transform旋转修正，了解了imageOrientation或者Meta的orientation这么做也是可以的比如示例图片中的imageOrientation == .right只需要使用CGAffineTransform顺时针旋转90度即可正确展示，这里不再赘述。</p>
</blockquote>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>先明确一个概念就是图片的真实存储信息是以相机传感器正向（相机正向就是横向模式，手机的话就是，竖平逆时针旋转90度），图片实际存储就是以传感器拍摄来存储的(传感器的物理上方就是图片的首行像素存储位置)，然后通过读取Meta中的方向信息（和imageOrientation有一一对应关系）通过transform正确展示。所谓<code>正确展示</code>是让传感器拍摄的图片的首行像素展示在上面。</li>
<li>正确操作Meta的方向信息应该使用Data方式来读取图片，而不是UIImage、CGImage或者CIImage，UIImage中具体是否包含正确的方向信息要看是通过何种方式创建的比如通过UIImage(data:xxx)是包含方向信息的，CGImage和CIImage都不包含正确的方向信息，通过其转化都会丢失正确的方向信息，也就是说通过CGImage、CIImage处理的图片或者非Data创建的UIImage都应该考虑图片方向问题。</li>
</ul>

  </section>

</article>

<section class="read-more">
           
    
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2020/01/13/iOS滤镜系列-滤镜开发概览/" title="iOS滤镜系列-滤镜开发概览">iOS滤镜系列-滤镜开发概览</a></h2>
                <p class="excerpt">
                
                
概述滤镜最早的出现应该是应用在相机镜头前实现自然光过滤和调色的镜片，然而在软件开发中更多的指的是软件滤镜，是对镜头滤镜的模拟实现。当然这种方式更加方便快捷，缺点自然就是无法还原拍摄时的真实场景，例如无法实现偏光镜和紫外线滤色镜的效果。今天简单介绍一下iOS滤镜开发中的正确姿势，让刚刚接触滤镜开发的
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2020-01-13T07:53:20.000Z" class="post-list__meta--date date">2020-01-13</time> &#8226; <span class="post-list__meta--tags tags">于&nbsp;
  <a class="tag-link" href="/tags/OpenGL-GPUImage-OpenCV-Core-Image-Metal/">OpenGL , GPUImage , OpenCV , Core Image , Metal</a>
</span><a class="btn-border-small" href="/2020/01/13/iOS滤镜系列-滤镜开发概览/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

  
<section class="post-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'kenshincui'; 
      
  var disqus_identifier = '/2020/02/03/iOS开发tip-图片方向/';
  var disqus_title = 'iOS开发tip-图片方向';
  var disqus_url = 'http://yoursite.com/2020/02/03/iOS开发tip-图片方向/';
  

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          //dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
          dsq.src = 'https://a.disquscdn.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


            <footer class="footer">
    <span class="footer__copyright">
        本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2020 - 本站使用 <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> 主题,
        由<a href="https://monniya.com ">@Monniya</a> 修改自 <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, 原创出自<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
    </span>
    
</footer>


        </div>
    </div>

     
    


    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
